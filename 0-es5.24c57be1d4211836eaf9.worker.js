function _toArray(e){return _arrayWithHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableRest()}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(e){return function(){var t,i=_getPrototypeOf(e);if(_isNativeReflectConstruct()){var r=_getPrototypeOf(this).constructor;t=Reflect.construct(i,arguments,r)}else t=i.apply(this,arguments);return _possibleConstructorReturn(this,t)}}function _possibleConstructorReturn(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var i=[],r=!0,n=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done)&&(i.push(o.value),!t||i.length!==t);r=!0);}catch(l){n=!0,a=l}finally{try{r||null==s.return||s.return()}finally{if(n)throw a}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _createForOfIteratorHelper(e){if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=_unsupportedIterableToArray(e))){var t=0,i=function(){};return{s:i,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,n,a=!0,o=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){o=!0,n=e},f:function(){try{a||null==r.return||r.return()}finally{if(o)throw n}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}!function(e){var t={};function i(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,(function(t){return e[t]}).bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s="OO65")}({Fu16:function(e,t,i){var r;!function(){"use strict";var n=.5*(Math.sqrt(3)-1),a=(3-Math.sqrt(3))/6,o=(Math.sqrt(5)-1)/4,s=(5-Math.sqrt(5))/20;function l(e){var t;t="function"==typeof e?e:e?function(){var e=0,t=0,i=0,r=1,n=d();e=n(" "),t=n(" "),i=n(" ");for(var a=0;a<arguments.length;a++)(e-=n(arguments[a]))<0&&(e+=1),(t-=n(arguments[a]))<0&&(t+=1),(i-=n(arguments[a]))<0&&(i+=1);return n=null,function(){var n=2091639*e+2.3283064365386963e-10*r;return e=t,t=i,i=n-(r=0|n)}}(e):Math.random,this.p=u(t),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(var i=0;i<512;i++)this.perm[i]=this.p[255&i],this.permMod12[i]=this.perm[i]%12}function u(e){var t,i=new Uint8Array(256);for(t=0;t<256;t++)i[t]=t;for(t=0;t<255;t++){var r=t+~~(e()*(256-t)),n=i[t];i[t]=i[r],i[r]=n}return i}function d(){var e=4022871197;return function(t){t=t.toString();for(var i=0;i<t.length;i++){var r=.02519603282416938*(e+=t.charCodeAt(i));r-=e=r>>>0,e=(r*=e)>>>0,e+=4294967296*(r-=e)}return 2.3283064365386963e-10*(e>>>0)}}l.prototype={grad3:new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),grad4:new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),noise2D:function(e,t){var i,r,o=this.permMod12,s=this.perm,l=this.grad3,u=0,d=0,c=0,h=(e+t)*n,f=Math.floor(e+h),p=Math.floor(t+h),y=(f+p)*a,v=e-(f-y),m=t-(p-y);v>m?(i=1,r=0):(i=0,r=1);var g=v-i+a,k=m-r+a,b=v-1+2*a,w=m-1+2*a,_=255&f,P=255&p,T=.5-v*v-m*m;if(T>=0){var O=3*o[_+s[P]];u=(T*=T)*T*(l[O]*v+l[O+1]*m)}var M=.5-g*g-k*k;if(M>=0){var C=3*o[_+i+s[P+r]];d=(M*=M)*M*(l[C]*g+l[C+1]*k)}var I=.5-b*b-w*w;if(I>=0){var F=3*o[_+1+s[P+1]];c=(I*=I)*I*(l[F]*b+l[F+1]*w)}return 70*(u+d+c)},noise3D:function(e,t,i){var r,n,a,o,s,l,u,d,c,h,f=this.permMod12,p=this.perm,y=this.grad3,v=(e+t+i)*(1/3),m=Math.floor(e+v),g=Math.floor(t+v),k=Math.floor(i+v),b=(m+g+k)*(1/6),w=e-(m-b),_=t-(g-b),P=i-(k-b);w>=_?_>=P?(s=1,l=0,u=0,d=1,c=1,h=0):w>=P?(s=1,l=0,u=0,d=1,c=0,h=1):(s=0,l=0,u=1,d=1,c=0,h=1):_<P?(s=0,l=0,u=1,d=0,c=1,h=1):w<P?(s=0,l=1,u=0,d=0,c=1,h=1):(s=0,l=1,u=0,d=1,c=1,h=0);var T=w-s+1/6,O=_-l+1/6,M=P-u+1/6,C=w-d+1/6*2,I=_-c+1/6*2,F=P-h+1/6*2,x=w-1+.5,S=_-1+.5,W=P-1+.5,A=255&m,R=255&g,E=255&k,L=.6-w*w-_*_-P*P;if(L<0)r=0;else{var H=3*f[A+p[R+p[E]]];r=(L*=L)*L*(y[H]*w+y[H+1]*_+y[H+2]*P)}var N=.6-T*T-O*O-M*M;if(N<0)n=0;else{var q=3*f[A+s+p[R+l+p[E+u]]];n=(N*=N)*N*(y[q]*T+y[q+1]*O+y[q+2]*M)}var D=.6-C*C-I*I-F*F;if(D<0)a=0;else{var j=3*f[A+d+p[R+c+p[E+h]]];a=(D*=D)*D*(y[j]*C+y[j+1]*I+y[j+2]*F)}var z=.6-x*x-S*S-W*W;if(z<0)o=0;else{var Y=3*f[A+1+p[R+1+p[E+1]]];o=(z*=z)*z*(y[Y]*x+y[Y+1]*S+y[Y+2]*W)}return 32*(r+n+a+o)},noise4D:function(e,t,i,r){var n,a,l,u,d,c,h,f,p,y,v,m,g,k,b,w,_,P=this.perm,T=this.grad4,O=(e+t+i+r)*o,M=Math.floor(e+O),C=Math.floor(t+O),I=Math.floor(i+O),F=Math.floor(r+O),x=(M+C+I+F)*s,S=e-(M-x),W=t-(C-x),A=i-(I-x),R=r-(F-x),E=0,L=0,H=0,N=0;S>W?E++:L++,S>A?E++:H++,S>R?E++:N++,W>A?L++:H++,W>R?L++:N++,A>R?H++:N++;var q=S-(c=E>=3?1:0)+s,D=W-(h=L>=3?1:0)+s,j=A-(f=H>=3?1:0)+s,z=R-(p=N>=3?1:0)+s,Y=S-(y=E>=2?1:0)+2*s,U=W-(v=L>=2?1:0)+2*s,B=A-(m=H>=2?1:0)+2*s,V=R-(g=N>=2?1:0)+2*s,G=S-(k=E>=1?1:0)+3*s,J=W-(b=L>=1?1:0)+3*s,K=A-(w=H>=1?1:0)+3*s,$=R-(_=N>=1?1:0)+3*s,Q=S-1+4*s,X=W-1+4*s,Z=A-1+4*s,ee=R-1+4*s,te=255&M,ie=255&C,re=255&I,ne=255&F,ae=.6-S*S-W*W-A*A-R*R;if(ae<0)n=0;else{var oe=P[te+P[ie+P[re+P[ne]]]]%32*4;n=(ae*=ae)*ae*(T[oe]*S+T[oe+1]*W+T[oe+2]*A+T[oe+3]*R)}var se=.6-q*q-D*D-j*j-z*z;if(se<0)a=0;else{var le=P[te+c+P[ie+h+P[re+f+P[ne+p]]]]%32*4;a=(se*=se)*se*(T[le]*q+T[le+1]*D+T[le+2]*j+T[le+3]*z)}var ue=.6-Y*Y-U*U-B*B-V*V;if(ue<0)l=0;else{var de=P[te+y+P[ie+v+P[re+m+P[ne+g]]]]%32*4;l=(ue*=ue)*ue*(T[de]*Y+T[de+1]*U+T[de+2]*B+T[de+3]*V)}var ce=.6-G*G-J*J-K*K-$*$;if(ce<0)u=0;else{var he=P[te+k+P[ie+b+P[re+w+P[ne+_]]]]%32*4;u=(ce*=ce)*ce*(T[he]*G+T[he+1]*J+T[he+2]*K+T[he+3]*$)}var fe=.6-Q*Q-X*X-Z*Z-ee*ee;if(fe<0)d=0;else{var pe=P[te+1+P[ie+1+P[re+1+P[ne+1]]]]%32*4;d=(fe*=fe)*fe*(T[pe]*Q+T[pe+1]*X+T[pe+2]*Z+T[pe+3]*ee)}return 27*(n+a+l+u+d)}},l._buildPermutationTable=u,void 0===(r=(function(){return l}).call(t,i,t,e))||(e.exports=r),t.SimplexNoise=l,e.exports=l}()},OO65:function(e,t,i){"use strict";var r,n,a,o,s,l;i.r(t),i.d(t,"tileUpdate",(function(){return ct})),i.d(t,"tileBulkUpdate",(function(){return ht})),i.d(t,"getCityDetails",(function(){return ft})),i.d(t,"cityProduce",(function(){return pt})),i.d(t,"cityGetRange",(function(){return yt})),i.d(t,"cityGetWorkTiles",(function(){return vt})),i.d(t,"cityWorkTile",(function(){return mt})),i.d(t,"cityUnworkTile",(function(){return gt})),i.d(t,"cityOptimizeYields",(function(){return kt})),i.d(t,"getAreaTiles",(function(){return bt})),i.d(t,"entityGetFailedWeakRequirements",(function(){return wt}));var u=i("Fu16"),d={food:0,production:0,culture:0,publicWorks:0};function c(e){e.food=0,e.production=0,e.culture=0,e.publicWorks=0}function h(e,t){e.food+=t.food,e.production+=t.production,e.culture+=t.culture,e.publicWorks+=t.publicWorks}function f(e,t){e.food=t.food,e.production=t.production,e.culture=t.culture,e.publicWorks=t.publicWorks}var p=function(e){return e[e.farm=0]="farm",e[e.mine=1]="mine",e[e.sawmill=2]="sawmill",e}({}),y=function(e){return e[e.road=0]="road",e}({}),v=(_defineProperty(r={},p.farm,15),_defineProperty(r,p.mine,15),_defineProperty(r,p.sawmill,15),r),m=(_defineProperty(n={},p.farm,1),_defineProperty(n,p.mine,1),_defineProperty(n,p.sawmill,1),n),g=_defineProperty({},y.road,15),k=_defineProperty({},y.road,1),b=function(e){return e[e.NW=0]="NW",e[e.NE=1]="NE",e[e.E=2]="E",e[e.SE=3]="SE",e[e.SW=4]="SW",e[e.W=5]="W",e[e.NONE=6]="NONE",e}({}),w=function(e){return e[e.tropical=0]="tropical",e[e.savanna=1]="savanna",e[e.desert=2]="desert",e[e.continental=3]="continental",e[e.oceanic=4]="oceanic",e[e.tundra=5]="tundra",e[e.arctic=6]="arctic",e}({}),_=function(e){return e[e.plains=0]="plains",e[e.hills=1]="hills",e[e.mountains=2]="mountains",e}({}),P=function(e){return e[e.none=0]="none",e[e.shallow=1]="shallow",e[e.deep=2]="deep",e}({}),T=new Set([w.continental,w.oceanic,w.tropical,w.tundra]),O=new Set([w.continental,w.oceanic,w.tropical]);function M(e){return e.seaLevel===P.none&&e.landForm===_.plains&&T.has(e.climate)}function C(e){return!(e.seaLevel!==P.none||e.landForm!==_.plains||!e.riverParts.length||!O.has(e.climate))}function I(e){return{turn:e.turn,map:F(e.map),players:e.players.map((function(e){return{id:(t=e).id,color:t.color,areaId:t.area.id,isAi:!!t.ai};var t})),trackedPlayer:A(e.trackedPlayer),units:e.unitsManager.units.map((function(e){return R(e)})),cities:e.citiesManager.cities.map((function(e){return S(e)}))}}function F(e){for(var t=[],i=0;i<e.width;i++){var r=[];t.push(r);for(var n=0;n<e.height;n++)r.push(x(e.tiles[i][n]))}return{width:e.width,height:e.height,tiles:t}}function x(e){return{id:e.id,x:e.x,y:e.y,climate:e.climate,forest:e.forest,improvement:e.improvement,landForm:e.landForm,riverParts:e.riverParts,road:e.road,seaLevel:e.seaLevel,wetlands:e.wetlands,yields:e.yields,areaOf:e.areaOf?e.areaOf.id:null,unitsIds:e.units.map((function(e){return e.id})),cityId:e.city?e.city.id:null}}function S(e){return{id:e.id,name:e.name,size:e.size,playerId:e.player.id,tileId:e.tile.id,totalFood:e.totalFood,foodToGrow:e.getFoodToGrow(),foodPerTurn:e.perTurn.food,turnsToGrow:e.turnsToGrow,totalProduction:e.totalProduction,productionPerTurn:e.yields.production,productionRequired:e.product?e.product.productDefinition.productionCost:null,turnsToProductionEnd:e.turnsToProductionEnd,productName:e.product?e.product.productDefinition.name:null}}function W(e){var t,i;return e.updateProductsList(),{id:e.id,name:e.name,size:e.size,playerId:e.player.id,tileId:e.tile.id,totalFood:e.totalFood,foodToGrow:e.getFoodToGrow(),turnsToGrow:e.turnsToGrow,totalProduction:e.totalProduction,turnsToProductionEnd:e.turnsToProductionEnd,availableBuildings:e.availableBuildings.map((function(e){return e.id})),availableIdleProducts:e.availableIdleProducts.map((function(e){return e.id})),availableUnits:e.availableUnits.map((function(e){return e.id})),buildingsIds:Array.from(e.buildingsIds),cultureToExpand:e.getCultureToExpand(),disabledBuildings:Array.from(e.disabledBuildings).map((function(e){return e.id})),disabledIdleProducts:Array.from(e.disabledIdleProducts).map((function(e){return e.id})),disabledUnits:Array.from(e.disabledUnits).map((function(e){return e.id})),foodConsumed:e.foodConsumed,perTurn:e.perTurn,productId:(null===(t=e.product)||void 0===t?void 0:t.productDefinition.id)||null,productType:(null===(i=e.product)||void 0===i?void 0:i.type)||null,tileYields:e.tileYields,tiles:Array.from(e.tiles).map((function(e){return e.id})),totalCulture:e.totalCulture,workedTiles:Array.from(e.workedTiles).map((function(e){return e.id})),yields:e.yields}}function A(e){return{id:e.id,color:e.color,exploredTiles:Array.from(e.exploredTiles).map((function(e){return e.id})),visibleTiles:Array.from(e.visibleTiles).map((function(e){return e.id})),units:e.units.map((function(e){return e.id})),cities:e.cities.map((function(e){return e.id})),yields:e.yields,isAi:!!e.ai}}function R(e){var t;return{id:e.id,tileId:e.tile.id,definitionId:e.definition.id,playerId:e.player.id,parentId:(null===(t=e.parent)||void 0===t?void 0:t.id)||null,childrenIds:e.children.map((function(e){return e.id})),health:e.health,actionPointsLeft:e.actionPointsLeft}}function E(e){var t,i;return{id:e.id,tileId:e.tile.id,definitionId:e.definition.id,playerId:e.player.id,parentId:(null===(t=e.parent)||void 0===t?void 0:t.id)||null,childrenIds:e.children.map((function(e){return e.id})),actionPointsLeft:e.actionPointsLeft,health:e.health,order:e.order,path:(null===(i=e.path)||void 0===i?void 0:i.map((function(e){return e.map((function(e){return e.id}))})))||null}}var L=new(function(){function e(){_classCallCheck(this,e),this.tiles=new Set,this.units=new Set,this.unitsDestroyed=new Set,this.cities=new Set,this.citiesDestroyed=new Set,this.areaTilesAdded=new Map,this.areaTilesRemoved=new Map,this.tilesExplored=new Set,this.tilesShowed=new Set,this.tilesShowedAdded=new Set}return _createClass(e,[{key:"flush",value:function(){var e,t=[],i=_createForOfIteratorHelper(this.units);try{for(i.s();!(e=i.n()).done;){var r=e.value;t.push({type:"unit.updated",data:R(r)})}}catch(P){i.e(P)}finally{i.f()}var n,a=_createForOfIteratorHelper(this.unitsDestroyed);try{for(a.s();!(n=a.n()).done;){var o=n.value;t.push({type:"unit.destroyed",data:o})}}catch(P){a.e(P)}finally{a.f()}var s,l=_createForOfIteratorHelper(this.cities);try{for(l.s();!(s=l.n()).done;){var u=s.value;t.push({type:"city.updated",data:S(u)})}}catch(P){l.e(P)}finally{l.f()}var d,c=_createForOfIteratorHelper(this.citiesDestroyed);try{for(c.s();!(d=c.n()).done;){var h=d.value;t.push({type:"city.destroyed",data:h})}}catch(P){c.e(P)}finally{c.f()}this.tiles.size&&t.push({type:"tiles.updated",data:Array.from(this.tiles).map((function(e){return x(e)}))});var f,p=_createForOfIteratorHelper(this.areaTilesAdded.entries());try{for(p.s();!(f=p.n()).done;){var y=_slicedToArray(f.value,2),v=y[0],m=y[1];t.push({type:"area.tilesAdded",data:{id:v,tiles:m.map((function(e){return e.id}))}})}}catch(P){p.e(P)}finally{p.f()}var g,k=_createForOfIteratorHelper(this.areaTilesRemoved.entries());try{for(k.s();!(g=k.n()).done;){var b=_slicedToArray(g.value,2),w=b[0],_=b[1];t.push({type:"area.tilesRemoved",data:{id:w,tiles:_.map((function(e){return e.id}))}})}}catch(P){k.e(P)}finally{k.f()}return this.turn&&t.push({type:"game.turn",data:this.turn}),this.trackedPlayer&&t.push({type:"trackedPlayer.set",data:A(this.trackedPlayer)}),this.trackedPlayerYields&&t.push({type:"trackedPlayer.yields",data:this.trackedPlayerYields}),this.tilesExplored.size&&t.push({type:"trackedPlayer.tilesExplored",data:Array.from(this.tilesExplored)}),this.tilesShowed.size&&t.push({type:"trackedPlayer.tilesShowed",data:Array.from(this.tilesShowed)}),this.tilesShowedAdded.size&&t.push({type:"trackedPlayer.tilesShowedAdded",data:Array.from(this.tilesShowedAdded)}),this.tiles.clear(),this.unitsDestroyed.clear(),this.units.clear(),this.cities.clear(),this.citiesDestroyed.clear(),this.areaTilesAdded.clear(),this.areaTilesRemoved.clear(),this.trackedPlayer=void 0,this.trackedPlayerYields=void 0,this.tilesExplored.clear(),this.tilesShowed.clear(),this.tilesShowedAdded.clear(),this.turn=void 0,t}},{key:"addAreaTiles",value:function(e,t){var i;this.areaTilesAdded.has(e)?(i=this.areaTilesAdded.get(e)).push.apply(i,_toConsumableArray(t)):this.areaTilesAdded.set(e,t)}},{key:"removeAreaTiles",value:function(e,t){var i;this.areaTilesRemoved.has(e)?(i=this.areaTilesRemoved.get(e)).push.apply(i,_toConsumableArray(t)):this.areaTilesRemoved.set(e,t)}},{key:"setVisibleTiles",value:function(e){var t,i=_createForOfIteratorHelper(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this.tilesShowed.add(r.id)}}catch(n){i.e(n)}finally{i.f()}}},{key:"addVisibleTiles",value:function(e){var t,i=_createForOfIteratorHelper(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this.tilesShowedAdded.add(r.id)}}catch(n){i.e(n)}finally{i.f()}}}]),e}()),H=(_defineProperty(a={},w.arctic,Object.assign({},d)),_defineProperty(a,w.continental,Object.assign(Object.assign({},d),{food:1,production:1})),_defineProperty(a,w.desert,Object.assign({},d)),_defineProperty(a,w.oceanic,Object.assign(Object.assign({},d),{food:2,production:1})),_defineProperty(a,w.savanna,Object.assign(Object.assign({},d),{food:1,production:1})),_defineProperty(a,w.tropical,Object.assign(Object.assign({},d),{food:1})),_defineProperty(a,w.tundra,Object.assign(Object.assign({},d),{production:1})),a),N=(_defineProperty(o={},_.plains,Object.assign({},d)),_defineProperty(o,_.hills,Object.assign(Object.assign({},d),{food:-1})),_defineProperty(o,_.mountains,Object.assign(Object.assign({},d),{food:-1/0,production:-5})),o),q=function(){function e(t,i,r){_classCallCheck(this,e),this.id=t,this.x=i,this.y=r,this.climate=w.continental,this.landForm=_.plains,this.seaLevel=P.deep,this.riverParts=[],this.forest=!1,this.wetlands=!1,this.improvement=null,this.road=null,this.units=[],this.city=null,this.areaOf=null,this.yields=Object.assign({},d),this.ethnicity=new Map,this.neighbours=[],this.fullNeighbours=[],this.neighboursCosts=new Map,this.sweetSpotValue=0,this.passableArea=0}return _createClass(e,[{key:"computeMovementCosts",value:function(){var e,t=_createForOfIteratorHelper(this.neighbours);try{for(t.s();!(e=t.n()).done;){var i=e.value,r=this.getDirectionTo(i),n=1;i.landForm===_.mountains?n=1/0:i.landForm===_.hills?n=2:this.riverParts.includes(r)?n=3:this.riverParts.length&&i.riverParts.length&&(n=.5),i.road===y.road&&(n/=3),i.forest&&(n*=2),this.neighboursCosts.set(i,n)}}catch(a){t.e(a)}finally{t.f()}}},{key:"getDirectionTo",value:function(e){return e.x===this.x-(this.y%2?0:1)&&e.y===this.y-1?b.NW:e.x===this.x+(this.y%2?1:0)&&e.y===this.y-1?b.NE:e.x===this.x+1&&e.y===this.y?b.E:e.x===this.x+(this.y%2?1:0)&&e.y===this.y+1?b.SE:e.x===this.x-(this.y%2?0:1)&&e.y===this.y+1?b.SW:e.x===this.x-1&&e.y===this.y?b.W:b.NONE}},{key:"getDistanceTo",value:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}},{key:"computeYields",value:function(){if(this.seaLevel===P.deep)this.yields.food=0,this.yields.production=0;else if(this.seaLevel===P.shallow)this.yields.food=1,this.yields.production=0;else{var e=H[this.climate],t=N[this.landForm];this.yields.food=e.food+t.food,this.yields.production=e.production+t.production,this.forest&&(this.yields.food--,this.yields.production++),this.wetlands&&(this.yields.food--,this.yields.production--),this.riverParts.length&&(this.yields.food+=this.climate===w.desert?3:1),this.improvement===p.farm?this.yields.food++:(this.improvement===p.mine||this.improvement===p.sawmill)&&this.yields.production++,this.yields.food=Math.max(0,this.yields.food),this.yields.production=Math.max(0,this.yields.production)}}},{key:"getTilesInRange",value:function(e){for(var t=new Set([this]),i=0;i<e;i++){var r,n=new Set,a=_createForOfIteratorHelper(t);try{for(a.s();!(r=a.n()).done;){var o,s=_createForOfIteratorHelper(r.value.neighbours);try{for(s.s();!(o=s.n()).done;){var l=o.value;n.add(l)}}catch(h){s.e(h)}finally{s.f()}}}catch(h){a.e(h)}finally{a.f()}var u,d=_createForOfIteratorHelper(n);try{for(d.s();!(u=d.n()).done;){var c=u.value;t.add(c)}}catch(h){d.e(h)}finally{d.f()}}return t}},{key:"computeSweetSpotValue",value:function(){if(this.sweetSpotValue=0,!this.areaOf&&this.landForm!==_.mountains&&this.seaLevel===P.none){var e,t=_createForOfIteratorHelper(this.getTilesInRange(3));try{for(t.s();!(e=t.n()).done;){var i=e.value;this.sweetSpotValue+=i.yields.food,this.sweetSpotValue+=i.yields.production}}catch(r){t.e(r)}finally{t.f()}}}},{key:"update",value:function(){this.computeYields(),this.computeMovementCosts();var e,t=_createForOfIteratorHelper(this.neighbours);try{for(t.s();!(e=t.n()).done;){e.value.computeMovementCosts()}}catch(i){t.e(i)}finally{t.f()}L.tiles.add(this)}},{key:"getFirstEnemyMilitaryUnit",value:function(e){return this.units.find((function(t){return t.definition.strength&&t.player!==e.player}))}},{key:"getFirstEnemyUnit",value:function(e){return this.units.find((function(t){return t.player!==e.player}))}},{key:"getEmbarkmentTarget",value:function(e){return this.units.find((function(t){return t.player===e.player&&t.definition.capacity&&t.children.length<t.definition.capacity}))}},{key:"totalYields",get:function(){return this.yields.food+this.yields.production}},{key:"isWater",get:function(){return this.seaLevel!==P.none}},{key:"isLand",get:function(){return!this.isWater}}]),e}();function D(e,t,i){return[z(e,e[t][i],b.NW),z(e,e[t][i],b.NE),z(e,e[t][i],b.E),z(e,e[t][i],b.SE),z(e,e[t][i],b.SW),z(e,e[t][i],b.W)]}function j(e,t,i){return D(e,t,i).filter((function(e){return!!e}))}function z(e,t,i){switch(i){case b.NW:return t.y%2==0&&0===t.x||0===t.y?null:e[t.x-(t.y%2?0:1)][t.y-1];case b.NE:return t.y%2&&t.x===e.length-1||0===t.y?null:e[t.x+(t.y%2?1:0)][t.y-1];case b.E:return t.x===e.length-1?null:e[t.x+1][t.y];case b.SE:return t.y%2&&t.x===e.length-1||t.y===e[t.x].length-1?null:e[t.x+(t.y%2?1:0)][t.y+1];case b.SW:return t.y%2==0&&0===t.x||t.y===e[t.x].length-1?null:e[t.x-(t.y%2?0:1)][t.y+1];case b.W:return 0===t.x?null:e[t.x-1][t.y]}return null}var Y=function(){function e(t,i){_classCallCheck(this,e),this.width=t,this.height=i,this.tiles=[],this.tilesMap=new Map;for(var r=0;r<t;r++){var n=[];this.tiles.push(n);for(var a=0;a<i;a++){var o=new q(r*t+a,r,a);n.push(o),this.tilesMap.set(o.id,o)}}for(var s=0;s<t;s++)for(var l=0;l<i;l++)this.tiles[s][l].neighbours=j(this.tiles,s,l),this.tiles[s][l].fullNeighbours=D(this.tiles,s,l)}return _createClass(e,[{key:"precompute",value:function(){for(var e=0;e<this.width;e++)for(var t=0;t<this.height;t++){var i=this.tiles[e][t];i.computeYields(),i.computeMovementCosts(),i.computeSweetSpotValue()}this.precomputePassableAreas()}},{key:"precomputePassableAreas",value:function(){for(var e=new Set,t=1,i=0;i<this.width;i++)for(var r=0;r<this.height;r++){var n=this.tiles[i][r];e.has(n)||n.landForm!==_.mountains&&this.computePassableArea(n,t++,e)}}},{key:"computePassableArea",value:function(e,t,i){var r=[e];for(i.add(e);r.length;){var n=r.shift();n.passableArea=t;var a,o=_createForOfIteratorHelper(n.neighbours);try{for(o.s();!(a=o.n()).done;){var s=a.value;if(!i.has(s)){var l=n.seaLevel===P.none&&s.seaLevel===P.none,u=n.seaLevel!==P.none&&s.seaLevel!==P.none;s.landForm===_.mountains||!l&&!u||(i.add(s),r.push(s))}}}catch(d){o.e(d)}finally{o.f()}}}},{key:"get",value:function(e,t){return e<0||e>=this.width||t<0||t>=this.height?null:this.tiles[e][t]}}]),e}(),U=(_defineProperty(s={},b.NW,[[b.NE,b.NW],[b.NONE,b.NE]]),_defineProperty(s,b.NE,[[b.E,b.NE],[b.NONE,b.E]]),_defineProperty(s,b.E,[[b.SE,b.E],[b.NONE,b.SE]]),_defineProperty(s,b.SE,[[b.SW,b.SE],[b.NONE,b.SW]]),_defineProperty(s,b.SW,[[b.W,b.SW],[b.NONE,b.W]]),_defineProperty(s,b.W,[[b.NW,b.W],[b.NONE,b.NW]]),_defineProperty(s,b.NONE,[[b.NONE,b.NONE],[b.NONE,b.NONE]]),s),B=(_defineProperty(l={},b.NW,b.SE),_defineProperty(l,b.NE,b.SW),_defineProperty(l,b.E,b.W),_defineProperty(l,b.SE,b.NW),_defineProperty(l,b.SW,b.NE),_defineProperty(l,b.W,b.E),_defineProperty(l,b.NONE,b.NONE),l),V=function(){function e(t){_classCallCheck(this,e),this.startingLocationsCount=t,this.startingLocations=[],this.riversSources=[],this.metadata=new Map}return _createClass(e,[{key:"getStartingLocations",value:function(){return this.startingLocations}},{key:"generate",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.5,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;this.map=new Y(e,t),this.width=e,this.height=t,this.seed=i,this.uniformity=r,this.seaLevel=n;for(var a=0;a<this.width;a++)for(var o=0;o<this.height;o++)this.metadata.set(this.map.tiles[a][o],{height:0,humidity:0,temperature:0});this.generateHeightmap(),this.generateMountainRanges(),this.generateTemperature(),this.generateHumidity();for(var s=0;s<this.width;s++)for(var l=0;l<this.height;l++){var u=this.map.tiles[s][l],d=this.metadata.get(u);d.height>1.3?u.landForm=_.mountains:d.height>.25&&(u.landForm=_.hills),u.climate=d.temperature<.2?d.temperature<.07?w.arctic:w.tundra:d.humidity<.1?w.desert:d.humidity<.3?w.savanna:d.humidity<.7&&d.temperature<.5?w.continental:d.temperature>.5?w.tropical:w.oceanic}var c,h=_createForOfIteratorHelper(this.getNoisedTiles(new G([[.015,1],[.06,1],[.3,1]],this.seed)));try{for(h.s();!(c=h.n()).done;){var f=_slicedToArray(c.value,3),p=f[0],y=f[1];f[2];y+(p.climate===w.tropical?.3:0)>-.2&&M(p)&&(p.forest=!0)}}catch(v){h.e(v)}finally{h.f()}return this.fixShallowWater(),this.adjustHeightmap(),this.placeRivers(),this.placeWetlands(),this.findStartingPositions(),this.map}},{key:"generateHeightmap",value:function(){for(var e=Math.max(this.width,this.height),t=Math.floor(Math.pow(e,.4)),i=[],r=0;r<t;r++)i.push([Math.pow(.6,r+4),1+this.uniformity*r]);var n,a=i.reduce((function(e,t){return e+t[1]}),0),o=a*this.seaLevel,s=new G(i,this.seed),l=new G([[.015,1],[.06,1],[.3,1]],this.seed),u=_createForOfIteratorHelper(this.getNoisedTiles(s));try{for(u.s();!(n=u.n()).done;){var d=_slicedToArray(n.value,3),c=d[0],h=d[1],f=(d[2],0),p=Math.min(c.x,this.width-c.x),y=.1*this.width;p<y&&(h-=a/2*Math.cos(Math.PI/2/y*p)),h>o&&(f=h,c.seaLevel=P.none,h>.05&&Math.random()>.97&&this.riversSources.push(c),f=l.at(c.x,c.y)),this.metadata.get(c).height=f}}catch(v){u.e(v)}finally{u.f()}}},{key:"generateTemperature",value:function(){var e,t=_createForOfIteratorHelper(this.getNoisedTiles(new G([[.012,1],[.07,1]],this.seed)));try{for(t.s();!(e=t.n()).done;){var i=_slicedToArray(e.value,3),r=i[0],n=i[1],a=i[2],o=(1-a)/2,s=(n+1)/2*(1-a);this.metadata.get(r).temperature=Math.max(o,Math.min(1,o+s))}}catch(l){t.e(l)}finally{t.f()}}},{key:"generateHumidity",value:function(){var e,t=_createForOfIteratorHelper(this.getNoisedTiles(new G([[.025,1],[.2,1]],this.seed)));try{for(t.s();!(e=t.n()).done;){var i=_slicedToArray(e.value,3),r=i[0],n=i[1],a=10*i[2],o=a<1.5*Math.PI?(Math.cos(a)+1)/2-.5:0,s=(n+1)/2;this.metadata.get(r).humidity=Math.max(0,Math.min(1,.8*o+s))}}catch(l){t.e(l)}finally{t.f()}}},{key:"generateMountainRanges",value:function(){}},{key:"getNoisedTiles",value:regeneratorRuntime.mark((function e(t){var i,r,n,a,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=0;case 1:if(!(i<this.width)){e.next=13;break}r=0;case 3:if(!(r<this.height)){e.next=10;break}return n=t.at(i,r),a=Math.floor(this.height/2),o=Math.abs((r-a)/a),e.next=7,[this.map.tiles[i][r],n,o];case 7:r++,e.next=3;break;case 10:i++,e.next=1;break;case 13:case"end":return e.stop()}}),e,this)}))},{key:"fixShallowWater",value:function(){for(var e=0;e<this.width;e++)for(var t=0;t<this.height;t++){var i=this.map.tiles[e][t];if(i.seaLevel===P.none){var r,n=_createForOfIteratorHelper(i.neighbours);try{for(n.s();!(r=n.n()).done;){var a=r.value;a.seaLevel===P.deep&&(a.seaLevel=P.shallow)}}catch(o){n.e(o)}finally{n.f()}}}}},{key:"adjustHeightmap",value:function(){for(var e=function(e){for(var t=[],i=0;i<e.length;i++)for(var r=0;r<e[i].length;r++){var n=e[i][r];n.seaLevel===P.none&&n.neighbours.find((function(e){return e.seaLevel!==P.none}))&&t.push(n)}return t}(this.map.tiles),t=new Set,i=new Set(e),r=0;e.length;){r+=.7;var n,a=_createForOfIteratorHelper(e);try{for(a.s();!(n=a.n()).done;){var o,s=_createForOfIteratorHelper(n.value.neighbours);try{for(s.s();!(o=s.n()).done;){var l=o.value;l.seaLevel!==P.none||i.has(l)||(i.add(l),t.add(l),this.metadata.get(l).height+=r)}}catch(u){s.e(u)}finally{s.f()}}}catch(u){a.e(u)}finally{a.f()}e=Array.from(t),t.clear()}}},{key:"placeRivers",value:function(){var e,t=_createForOfIteratorHelper(this.riversSources);try{for(t.s();!(e=t.n()).done;){var i=e.value;if(!i.riverParts.length){var r,n=!0,a=_createForOfIteratorHelper(i.neighbours);try{for(a.s();!(r=a.n()).done;){r.value.seaLevel!==P.none&&(n=!1)}}catch(o){a.e(o)}finally{a.f()}n&&this.buildRiverPath(i,Math.round(5*Math.random()))}}}catch(o){t.e(o)}finally{t.f()}}},{key:"buildRiverPath",value:function(e,t){var i=this;if(t!==b.NONE){var r=U[t].map((function(t){return t.map((function(t){return t===b.NONE?e:z(i.map.tiles,e,t)}))})).filter((function(e){return e[0]&&e[1]&&e[0].seaLevel===P.none&&e[1].seaLevel===P.none&&e[0].riverParts.length<4&&e[1].riverParts.length<4}));if(0!==r.length){var n;if(1===r.length)n=r[0];else{var a=_slicedToArray(r,2),o=a[0],s=a[1];n=(this.metadata.get(o[0]).height+this.metadata.get(o[1]).height)/2<(this.metadata.get(s[0]).height+this.metadata.get(s[1]).height)/2?o:s}(function(e,t){var i=e.getDirectionTo(t);return!e.riverParts.includes(i)&&(e.riverParts.push(i),t.riverParts.push(B[i]),!0)}).apply(void 0,_toConsumableArray(n))&&this.buildRiverPath(n[0],n[0].getDirectionTo(n[1]))}}}},{key:"placeWetlands",value:function(){var e,t=_createForOfIteratorHelper(this.getNoisedTiles(new G([[.021,1],[.08,1],[.2,1]],this.seed)));try{for(t.s();!(e=t.n()).done;){var i=_slicedToArray(e.value,3),r=i[0],n=i[1];i[2];n>0&&C(r)&&(r.wetlands=!0)}}catch(a){t.e(a)}finally{t.f()}}},{key:"findStartingPositions",value:function(){for(var e=0;e<1e4&&this.startingLocations.length<this.startingLocationsCount;){var t=Math.floor(Math.random()*this.width),i=Math.floor(Math.random()*this.height),r=this.map.tiles[t][i];r.seaLevel!==P.none||r.landForm===_.mountains||this.startingLocations.includes(r)||this.startingLocations.push(r),e++}}}]),e}(),G=function(){function e(t,i){_classCallCheck(this,e),this.scales=t,this.noises=t.map((function(){return new u(i)}))}return _createClass(e,[{key:"at",value:function(e,t){for(var i=0,r=0;r<this.noises.length;r++){var n=_slicedToArray(this.scales[r],2),a=n[0],o=n[1];i+=this.noises[r].noise2D(e*a,t*a)*o}return i}}]),e}(),J={buildFarm:p.farm,buildMine:p.mine,buildSawmill:p.sawmill},K=function e(){_classCallCheck(this,e),this.id=this.constructor.id},$=function(e){_inherits(i,e);var t=_createSuper(i);function i(){var e;return _classCallCheck(this,i),(e=t.apply(this,arguments)).id="ownTile",e}return _createClass(i,[{key:"check",value:function(e){var t;return(null===(t=e.tile.areaOf)||void 0===t?void 0:t.player)===e.player}}]),i}(K),Q=function(e){_inherits(i,e);var t=_createSuper(i);function i(e){var r;return _classCallCheck(this,i),(r=t.call(this)).improvement=e,r.id="sameImprovement",r}return _createClass(i,[{key:"check",value:function(e){return e.tile.improvement!==this.improvement}}]),i}(K),X=function(e){_inherits(i,e);var t=_createSuper(i);function i(e){var r;return _classCallCheck(this,i),(r=t.call(this)).improvement=e,r.id="improvementPossible",r}return _createClass(i,[{key:"check",value:function(e){return t=e.tile,null===(i=this.improvement)||(i===p.farm?t.seaLevel===P.none&&t.landForm===_.plains&&t.climate!==w.arctic&&!t.forest&&!t.wetlands:i===p.mine?t.landForm===_.hills:i===p.sawmill&&t.forest&&!t.wetlands);var t,i}}]),i}(K),Z=function(e){_inherits(i,e);var t=_createSuper(i);function i(){var e;return _classCallCheck(this,i),(e=t.apply(this,arguments)).id="publicWorks",e}return _createClass(i,[{key:"check",value:function(e,t){return e.player.yields.total.publicWorks>=function(e){if("buildRoad"===e)return g[y.road];var t=J[e];return void 0!==t?v[t]:0}(t)}}]),i}(K);function ee(e,t,i){t.actionPointsLeft=0,t.tile.improvement=i,t.tile.update(),t.player.updateUnitsWithoutOrders(),t.player.yields.total.publicWorks-=v[i],t.player.yields.costs.publicWorks+=m[i],t.player.yields.perTurn.publicWorks-=m[i]}var te={foundCity:{action:"foundCity",name:"Found a city",fn:function(e,t){e.citiesManager.spawn(t.tile,t.player)&&e.unitsManager.destroy(t)},requirements:[new(function(e){_inherits(i,e);var t=_createSuper(i);function i(){var e;return _classCallCheck(this,i),(e=t.apply(this,arguments)).id="notForeignTile",e}return _createClass(i,[{key:"check",value:function(e){var t;return!e.tile.areaOf||(null===(t=e.tile.areaOf)||void 0===t?void 0:t.player)===e.player}}]),i}(K))]},buildFarm:{action:"buildFarm",name:"Build a farm",fn:function(e,t){return ee(0,t,p.farm)},requirements:[new $,new Q(p.farm),new X(p.farm),new Z]},buildMine:{action:"buildMine",name:"Build a mine",fn:function(e,t){return ee(0,t,p.mine)},requirements:[new $,new Q(p.mine),new X(p.mine),new Z]},buildSawmill:{action:"buildSawmill",name:"Build a sawmill",fn:function(e,t){return ee(0,t,p.sawmill)},requirements:[new $,new Q(p.sawmill),new X(p.sawmill),new Z]},buildRoad:{action:"buildRoad",name:"Build a road",fn:function(e,t){return function(e,t){t.actionPointsLeft=0,t.tile.road=y.road,t.tile.update();var i,r=_createForOfIteratorHelper(t.tile.neighbours);try{for(r.s();!(i=r.n()).done;){i.value.update()}}catch(n){r.e(n)}finally{r.f()}t.player.updateUnitsWithoutOrders(),t.player.yields.total.publicWorks-=g[y.road],t.player.yields.costs.publicWorks+=k[y.road],t.player.yields.perTurn.publicWorks-=k[y.road]}(0,t)},requirements:[new(function(e){_inherits(i,e);var t=_createSuper(i);function i(){var e;return _classCallCheck(this,i),(e=t.apply(this,arguments)).id="noRoad",e}return _createClass(i,[{key:"check",value:function(e){return null===e.tile.road}}]),i}(K)),new(function(e){_inherits(i,e);var t=_createSuper(i);function i(){var e;return _classCallCheck(this,i),(e=t.apply(this,arguments)).id="roadPossible",e}return _createClass(i,[{key:"check",value:function(e){return(t=e.tile).seaLevel===P.none&&t.landForm!==_.mountains;var t}}]),i}(K)),new Z]}},ie=function(e){return e[e.hills=0]="hills",e[e.forest=1]="forest",e[e.river=2]="river",e[e.health=3]="health",e[e.flanks=4]="flanks",e}({}),re=function(e){return e[e.victory=0]="victory",e[e.undecided=1]="undecided",e[e.defeat=2]="defeat",e}({});function ne(e,t){var i=[].concat(_toConsumableArray(ae(e)),_toConsumableArray(function(e,t){var i=[],r=se(e,t);return r&&i.push({type:ie.flanks,value:.15*r}),i}(e,t))),r=[].concat(_toConsumableArray(ae(t)),_toConsumableArray(function(e,t){var i=[];t.tile.landForm===_.hills&&i.push({type:ie.hills,value:.5}),t.tile.forest&&i.push({type:ie.forest,value:.3});var r=t.tile.getDirectionTo(e.tile);t.tile.riverParts.includes(r)&&i.push({type:ie.river,value:.5});var n=se(t,e);return n&&i.push({type:ie.flanks,value:.15*n}),i}(e,t))),n=e.definition.strength*i.reduce((function(e,t){return e+t.value}),1),a=t.definition.strength*r.reduce((function(e,t){return e+t.value}),1);return{attacker:{strength:n,modifiers:i,damage:oe(a/n)},defender:{strength:a,modifiers:r,damage:oe(n/a)}}}function ae(e){var t=[];return e.health<100&&t.push({type:ie.health,value:(e.health-100)/200}),t}function oe(e){var t=(Math.pow((e+3)/4,4)+1)/2;return Math.round(30*t)}function se(e,t){return t.tile.neighbours.filter((function(t){return!!t.units.find((function(t){return t.player===e.player&&t.definition.strength}))})).length-1}var le=function(e){return e[e.none=0]="none",e[e.move=1]="move",e[e.embark=2]="embark",e[e.disembark=3]="disembark",e[e.attack=4]="attack",e}({});function ue(e,t,i){var r,n;if(!e.player.exploredTiles.has(i))return le.move;if("naval"===e.definition.type){if(t.passableArea!==i.passableArea)return i.isLand&&(null===(r=i.city)||void 0===r?void 0:r.isCoastline)&&(null===(n=i.city)||void 0===n?void 0:n.player)===e.player||i.isWater&&t.city?le.move:le.none;if(i.isLand)return le.none}else if("land"===e.definition.type){if(i.isWater&&i.getEmbarkmentTarget(e))return le.embark;if(e.parent&&t.isWater&&i.isLand)return le.disembark;if(t.passableArea!==i.passableArea||i.isWater)return le.none}if(e.player.visibleTiles.has(i)){var a=i.getFirstEnemyUnit(e),o=i.city&&i.city.player!==e.player;if(a||o)return e.definition.strength?le.attack:le.none}return le.move}function de(e,t,i,r){var n=i.neighboursCosts.get(r)||1/0;return t===le.move?n:t===le.attack?3*n:t===le.embark||t===le.disembark?Math.max(1,e.actionPointsLeft):1/0}function ce(e,t){var i;if(e.actionPointsLeft){var r=ue(e,e.tile,t),n=de(e,r,e.tile,t);if(r!==le.none)if(r===le.embark){var a=t.getEmbarkmentTarget(e);a&&a.addChild(e),he(e,t,n)}else r===le.disembark?(null===(i=e.parent)||void 0===i||i.removeChild(e),he(e,t,n)):r===le.attack?function(e,t){var i,r,n,a=t.getFirstEnemyUnit(e);if(a){if(e.actionPointsLeft=Math.max(e.actionPointsLeft-3,0),n=ne(i=e,r=a),i.health-=n.attacker.damage,r.health-=n.defender.damage,i.health>0&&L.units.add(i),r.health>0&&L.units.add(r),(i.health<=0?(i.destroy(),re.defeat):r.health<=0?(r.destroy(),re.victory):re.undecided)!==re.victory)return!1;if(t.getFirstEnemyMilitaryUnit(e))return!1}var o,s=_createForOfIteratorHelper(t.units.filter((function(t){return t.player!==e.player})));try{for(s.s();!(o=s.n()).done;){o.value.destroy()}}catch(l){s.e(l)}finally{s.f()}return t.city&&t.city.player!==e.player&&t.city.changeOwner(e.player),!0}(e,t)&&he(e,t,n):r===le.move&&he(e,t,n)}}function he(e,t,i){var r=e.tile.units.indexOf(e);-1!==r&&e.tile.units.splice(r,1),t.units.push(e),e.tile=t,e.actionPointsLeft=Math.max(e.actionPointsLeft-i,0);var n=e.getVisibleTiles();e.player.exploreTiles(n),e.player.showTiles(n);var a,o=_createForOfIteratorHelper(e.children);try{for(o.s();!(a=o.n()).done;){var s=a.value;he(s,t,0),L.units.add(s)}}catch(l){o.e(l)}finally{o.f()}}function fe(e){if(e.path){for(e.setOrder(e.path.length?"go":null),L.units.add(e);e.actionPointsLeft&&e.path.length;)if(e.path[0][0]!==e.tile&&ce(e,e.path[0][0]),e.path[0].shift(),e.path[0].length||e.path.shift(),!e.path.length)return e.path=null,void e.setOrder(null)}else e.setOrder(null)}for(var pe=function(){function e(t,i,r,n){_classCallCheck(this,e),this.tile=t,this.definition=i,this.player=r,this.unitManager=n,this.health=100,this.parent=null,this.children=[],this.order=null,this.actionPointsLeft=i.actionPoints}return _createClass(e,[{key:"doAction",value:function(e){this.canDoAction(e)&&(te[e].fn(this.player.game,this),L.unitsDestroyed.has(this.id)||L.units.add(this))}},{key:"canDoAction",value:function(e){if(!this.actionPointsLeft)return!1;if(!this.definition.actions.includes(e))return!1;var t,i=_createForOfIteratorHelper(te[e].requirements);try{for(i.s();!(t=i.n()).done;){if(!t.value.check(this,e))return!1}}catch(r){i.e(r)}finally{i.f()}return!0}},{key:"getFailedActionRequirements",value:function(e){var t=this;return te[e].requirements.filter((function(i){return!i.check(t,e)})).map((function(e){return e.id}))}},{key:"setOrder",value:function(e){this.order=e,this.player.updateUnitsWithoutOrders()}},{key:"getPathDestination",value:function(){if(!this.path)return null;var e=this.path[this.path.length-1];return e[e.length-1]}},{key:"getRange",value:function(){var e=new Set([this.tile]),t=new Map;return this._getRange(this.tile,this.actionPointsLeft,e,t),1===e.size&&e.delete(this.tile),e}},{key:"_getRange",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.tile,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.actionPointsLeft,i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0;if(t<=0)return i;var n,a=_createForOfIteratorHelper(e.neighbours);try{for(a.s();!(n=a.n()).done;){var o=n.value,s=ue(this,e,o),l=de(this,s,e,o);if(s!==le.none){var u=r.get(o),d=t-l;(!u||d>u)&&(r.set(o,d),i.add(o),s!==le.attack&&this._getRange(o,d,i,r))}}}catch(c){a.e(c)}finally{a.f()}return i}},{key:"addChild",value:function(e){this.children.includes(e)||(e.parent&&e.parent.removeChild(e),this.children.push(e),e.parent=this,L.units.add(this))}},{key:"removeChild",value:function(e){var t=this.children.findIndex((function(t){return t===e}));-1!==t&&(this.children.splice(t,1),e.parent=null,L.units.add(this))}},{key:"destroy",value:function(){this.unitManager.destroy(this)}},{key:"getVisibleTiles",value:function(){return this.tile.getTilesInRange(2)}}]),e}(),ye=function e(){_classCallCheck(this,e),this.context={}},ve=function(e){_inherits(i,e);var t=_createSuper(i);function i(e){var r;return _classCallCheck(this,i),(r=t.call(this)).id="building",r.context={buildingId:e},r}return _createClass(i,[{key:"check",value:function(e,t){return!!t&&t.buildingsIds.has(this.context.buildingId)}}]),i}(ye),me=function(e){_inherits(i,e);var t=_createSuper(i);function i(e){var r;return _classCallCheck(this,i),(r=t.call(this)).id="size",r.context={size:e},r}return _createClass(i,[{key:"check",value:function(e,t){return!!t&&t.size>=this.context.size}}]),i}(ye),ge=function(e){_inherits(i,e);var t=_createSuper(i);function i(){var e;return _classCallCheck(this,i),(e=t.apply(this,arguments)).id="coastlineCity",e}return _createClass(i,[{key:"check",value:function(e,t){return!!t&&t.isCoastline}}]),i}(ye),ke=[{id:"building_granary",name:"Granary",productionCost:40,bonuses:{yieldValue:{food:3}},strongRequirements:[],weakRequirements:[]},{id:"building_well",name:"Well",productionCost:20,bonuses:{yieldValue:{food:1}},strongRequirements:[],weakRequirements:[]},{id:"building_big_granary",name:"Grand granary",productionCost:100,bonuses:{yieldFactor:{food:.2}},strongRequirements:[new ve("building_granary")],weakRequirements:[]},{id:"building_workshop",name:"Workshop",productionCost:80,bonuses:{yieldValue:{production:5}},strongRequirements:[],weakRequirements:[]},{id:"building_big_workshop",name:"Grand workshop",productionCost:200,bonuses:{yieldFactor:{production:.2}},strongRequirements:[new ve("building_workshop")],weakRequirements:[]},{id:"building_slave_market",name:"Slave market",productionCost:50,bonuses:{yieldValue:{publicWorks:2}},strongRequirements:[],weakRequirements:[]},{id:"building_monument",name:"Monument",productionCost:30,bonuses:{yieldValue:{culture:2}},strongRequirements:[],weakRequirements:[]},{id:"building_all_doing_building",name:"All doing building",productionCost:500,bonuses:{yieldValue:{food:1,production:1},yieldFactor:{food:.1,production:.1}},strongRequirements:[new ve("building_big_granary"),new ve("building_big_workshop")],weakRequirements:[]}],be=[{id:"idle_product_growth",name:"Growth",productionCost:1/0,strongRequirements:[],weakRequirements:[],bonuses:{transferProductionToFood:.25}},{id:"idle_product_culture",name:"Culture",productionCost:1/0,strongRequirements:[],weakRequirements:[],bonuses:{transferProductionToCulture:.25}},{id:"idle_product_public_works",name:"Public works",productionCost:1/0,strongRequirements:[],weakRequirements:[],bonuses:{transferProductionToPublicWorks:.25}}],we=[{id:"unit_settler",name:"Settler",type:"land",actionPoints:2,strength:0,actions:["foundCity"],productionCost:50,capacity:0,strongRequirements:[],weakRequirements:[new ve("building_granary"),new me(3)]},{id:"unit_worker",name:"Worker",type:"land",actionPoints:2,strength:0,actions:["buildFarm","buildMine","buildSawmill","buildRoad"],productionCost:20,capacity:0,strongRequirements:[],weakRequirements:[new me(2)]},{id:"unit_scout",name:"Scout",type:"land",actionPoints:2,strength:2,actions:[],productionCost:10,capacity:0,strongRequirements:[],weakRequirements:[]},{id:"unit_warrior",name:"Warrior",type:"land",actionPoints:2,strength:5,actions:[],productionCost:30,capacity:0,strongRequirements:[],weakRequirements:[]},{id:"unit_tireme",name:"Tireme",type:"naval",actionPoints:3,strength:5,actions:[],productionCost:50,capacity:0,strongRequirements:[new ge],weakRequirements:[]},{id:"unit_galley",name:"Galley",type:"naval",actionPoints:3,strength:3,actions:[],productionCost:50,capacity:2,strongRequirements:[new ge],weakRequirements:[]}],_e=function(e){return e[e.organization=0]="organization",e[e.economics=1]="economics",e}({}),Pe=[{section:_e.organization,id:"government_organization_tribalism",name:"tribalism",bonuses:{culturePerKilledEnemy:.5},strongRequirements:[],weakRequirements:[]},{section:_e.organization,id:"government_organization_despotism",name:"despotism",bonuses:{},strongRequirements:[],weakRequirements:[]},{section:_e.economics,id:"government_economics_barter",name:"barter",bonuses:{},strongRequirements:[],weakRequirements:[]}],Te=new Map,Oe=new Map,Me=0,Ce=we;Me<Ce.length;Me++){var Ie=Ce[Me];Oe.set(Ie.id,Ie),Te.set(Ie.id,Ie)}for(var Fe=new Map,xe=0,Se=ke;xe<Se.length;xe++){var We=Se[xe];Fe.set(We.id,We),Te.set(We.id,We)}for(var Ae=new Map,Re=0,Ee=be;Re<Ee.length;Re++){var Le=Ee[Re];Ae.set(Le.id,Le),Te.set(Le.id,Le)}for(var He=new Map,Ne=0,qe=Pe;Ne<qe.length;Ne++){var De=qe[Ne];He.set(De.id,De),Te.set(De.id,De)}function je(e){var t=Oe.get(e);if(!t)throw Error('DataManager: No unit with id "'.concat(e,'"'));return t}function ze(e){var t=Fe.get(e);if(!t)throw Error('DataManager: No building with id "'.concat(e,'"'));return t}function Ye(e){var t=Ae.get(e);if(!t)throw Error('DataManager: No idle product with id "'.concat(e,'"'));return t}function Ue(e){var t=He.get(e);if(!t)throw Error('DataManager: No government option with id "'.concat(e,'"'));return t}var Be=function(){function e(){_classCallCheck(this,e),this.units=[],this.unitsMap=new Map,this.lastId=0}return _createClass(e,[{key:"spawn",value:function(e,t,i){var r=je(e),n=new pe(t,r,i,this);return n.id=this.lastId++,this.units.push(n),this.unitsMap.set(n.id,n),i.units.push(n),t.units.push(n),n.player.exploreTiles(n.tile.getTilesInRange(2)),n.player.unitsWithoutOrders.push(n),L.units.add(n),n}},{key:"destroy",value:function(e){this.unitsMap.delete(e.id);var t=this.units.indexOf(e);-1!==t&&this.units.splice(t,1),-1!==(t=e.player.units.indexOf(e))&&e.player.units.splice(t,1),-1!==(t=e.tile.units.indexOf(e))&&e.tile.units.splice(t,1),e.player.updateUnitsWithoutOrders(),L.unitsDestroyed.add(e.id)}},{key:"nextTurn",value:function(){var e,t,i=_createForOfIteratorHelper(this.units);try{for(i.s();!(t=i.n()).done;){var r=t.value;r.health<100&&(null===(e=r.tile.areaOf)||void 0===e?void 0:e.player)===r.player&&(r.health=Math.min(100,r.health+10),L.units.add(r)),r.path&&fe(r),"skip"===r.order&&r.setOrder(null),r.actionPointsLeft<r.definition.actionPoints&&(r.actionPointsLeft=r.definition.actionPoints,L.units.add(r))}}catch(n){i.e(n)}finally{i.f()}}}]),e}(),Ve=function e(){_classCallCheck(this,e),this.revealMap=!1},Ge=function(){function e(t,i){_classCallCheck(this,e),this.tile=t,this.player=i,this.totalFood=0,this.foodConsumed=1,this.totalCulture=0,this.tileYields=Object.assign({},d),this.yields=Object.assign({},d),this.perTurn=Object.assign({},d),this.product=null,this.totalProduction=0,this.buildings=[],this.buildingsIds=new Set,this.tiles=new Set,this.visibleTiles=new Set,this.workedTiles=new Set,this.notWorkedTiles=new Set,this.availableBuildings=[],this.disabledBuildings=new Set,this.availableUnits=[],this.disabledUnits=new Set,this.availableIdleProducts=[],this.disabledIdleProducts=new Set,this.changedSize=!1,this.isCoastline=!1,this.addTile(t)}return _createClass(e,[{key:"nextTurn",value:function(){this.changedSize=!1,this.progressExpansion(),this.progressProduction(),this.progressGrowth(),this.updateYields(),(this.player===this.player.game.trackedPlayer||this.changedSize)&&L.cities.add(this)}},{key:"progressProduction",value:function(){this.product&&(this.totalProduction+=this.yields.production,this.totalProduction>=this.product.productDefinition.productionCost&&("unit"===this.product.type?this.player.game.unitsManager.spawn(this.product.productDefinition.id,this.tile,this.player):"building"===this.product.type&&(this.buildings.push(this.product.productDefinition),this.buildingsIds.add(this.product.productDefinition.id)),this.totalProduction=0,this.product=null))}},{key:"progressGrowth",value:function(){this.totalFood+=this.yields.food-this.foodConsumed;var e=this.getFoodToGrow();if(this.totalFood>=e){this.size++,this.changedSize=!0;var t=this.pickBestTileToWork(this.notWorkedTiles);t&&this.workTile(t),this.totalFood-=e}else this.totalFood<0&&(this.size>1?(this.size--,this.changedSize=!0,this.totalFood+=e):this.totalFood=0)}},{key:"progressExpansion",value:function(){this.totalCulture+=this.perTurn.culture;var e=this.getCultureToExpand();if(this.totalCulture>=e){this.totalCulture-=e;var t=this.pickBestTileToExpand(this.tile,this.getTilesAvailableForExpansion());t&&(this.addTile(t),t.sweetSpotValue=0)}}},{key:"getCultureToExpand",value:function(){return Math.ceil(5*Math.pow(1.2,this.tiles.size))}},{key:"getFoodToGrow",value:function(){return Math.ceil(15*Math.pow(1.2,this.size))}},{key:"produceUnit",value:function(e){this.startProducing({type:"unit",productDefinition:e})}},{key:"produceBuilding",value:function(e){this.canConstruct(e)&&this.startProducing({type:"building",productDefinition:e})}},{key:"workOnIdleProduct",value:function(e){this.startProducing({type:"idleProduct",productDefinition:e}),this.updateYields(),this.player.updateYields()}},{key:"cancelProduction",value:function(){if(this.product){var e=this.product.type;this.product=null,"idleProduct"===e&&(this.updateYields(),this.player.updateYields())}}},{key:"startProducing",value:function(e){this.canProduce(e.productDefinition)&&(this.cancelProduction(),this.product=e,this.totalProduction=0,L.cities.add(this))}},{key:"getTurnsToProduce",value:function(e){return Math.ceil(e.productionCost/this.yields.production)}},{key:"updateYields",value:function(){var e,t;c(this.tileYields),this.tileYields.food=2,this.tileYields.production=1;var i,r=_createForOfIteratorHelper(this.workedTiles);try{for(r.s();!(i=r.n()).done;){var n=i.value;h(this.tileYields,n.yields)}}catch(l){r.e(l)}finally{r.f()}this.tileYields.production+=this.freeTileWorkers,f(this.yields,this.tileYields);var a,o=_createForOfIteratorHelper(this.buildings);try{for(o.s();!(a=o.n()).done;){var s=a.value;this.applyBonuses(s.bonuses)}}catch(l){o.e(l)}finally{o.f()}"idleProduct"===(null===(e=this.product)||void 0===e?void 0:e.type)&&this.applyBonuses(this.product.productDefinition.bonuses),(t=this.yields).food=Math.ceil(t.food),t.production=Math.ceil(t.production),t.culture=Math.ceil(t.culture),t.publicWorks=Math.ceil(t.publicWorks),this.foodConsumed=this.size,f(this.perTurn,this.yields),this.perTurn.food-=this.foodConsumed}},{key:"applyBonuses",value:function(e){var t,i,r,n,a,o,s,l;this.yields.food+=(null===(t=e.yieldValue)||void 0===t?void 0:t.food)||0,this.yields.production+=(null===(i=e.yieldValue)||void 0===i?void 0:i.production)||0,this.yields.culture+=(null===(r=e.yieldValue)||void 0===r?void 0:r.culture)||0,this.yields.publicWorks+=(null===(n=e.yieldValue)||void 0===n?void 0:n.publicWorks)||0,(null===(a=e.yieldFactor)||void 0===a?void 0:a.food)&&(this.yields.food+=this.tileYields.food*e.yieldFactor.food),(null===(o=e.yieldFactor)||void 0===o?void 0:o.production)&&(this.yields.production+=this.tileYields.production*e.yieldFactor.production),(null===(s=e.yieldFactor)||void 0===s?void 0:s.culture)&&(this.yields.culture+=this.tileYields.culture*e.yieldFactor.culture),(null===(l=e.yieldFactor)||void 0===l?void 0:l.publicWorks)&&(this.yields.publicWorks+=this.tileYields.publicWorks*e.yieldFactor.publicWorks),e.transferProductionToFood&&(this.yields.food+=this.yields.production*e.transferProductionToFood),e.transferProductionToCulture&&(this.yields.culture+=this.yields.production*e.transferProductionToCulture),e.transferProductionToPublicWorks&&(this.yields.publicWorks+=this.yields.production*e.transferProductionToPublicWorks)}},{key:"addTile",value:function(e){e.areaOf||(this.tiles.add(e),this.notWorkedTiles.add(e),e.areaOf=this,this.player.area.add(e),this.player.exploreTiles([e]),this.player.exploreTiles(e.neighbours),L.tiles.add(e))}},{key:"removeTile",value:function(e){this.tiles.has(e)&&(this.tiles.delete(e),e.areaOf=null,this.player.area.remove(e),L.tiles.add(e))}},{key:"workTile",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.freeTileWorkers&&this.tiles.has(e)&&(this.workedTiles.add(e),this.notWorkedTiles.delete(e),t&&this.updateYields())}},{key:"unworkTile",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.workedTiles.delete(e),this.notWorkedTiles.add(e),t&&this.updateYields()}},{key:"getTilesAvailableForExpansion",value:function(){var e,t=new Set,i=_createForOfIteratorHelper(this.tiles);try{for(i.s();!(e=i.n()).done;){var r,n=_createForOfIteratorHelper(e.value.neighbours);try{for(n.s();!(r=n.n()).done;){var a=r.value;a.areaOf||t.add(a)}}catch(o){n.e(o)}finally{n.f()}}}catch(o){i.e(o)}finally{i.f()}return t}},{key:"pickBestTileToWork",value:function(e){var t,i=null,r=0,n=_createForOfIteratorHelper(e);try{for(n.s();!(t=n.n()).done;){var a=t.value,o=a.totalYields;o>r&&(r=o,i=a)}}catch(s){n.e(s)}finally{n.f()}return i}},{key:"pickBestTileToExpand",value:function(e,t){var i,r=null,n=-1/0,a=_createForOfIteratorHelper(t);try{for(a.s();!(i=a.n()).done;){var o=i.value,s=o.totalYields-e.getDistanceTo(o)/2;s>n&&(n=s,r=o)}}catch(l){a.e(l)}finally{a.f()}return r}},{key:"optimizeYields",value:function(){for(this.workedTiles.clear(),this.notWorkedTiles=new Set(this.tiles);this.freeTileWorkers&&this.notWorkedTiles.size;){var e=this.pickBestTileToWork(this.notWorkedTiles);if(!e)break;this.workTile(e,!1)}this.updateYields()}},{key:"canConstruct",value:function(e){return!this.buildings.includes(e)}},{key:"canProduce",value:function(e){return function(e,t,i){var r,n=_createForOfIteratorHelper(e.strongRequirements);try{for(n.s();!(r=n.n()).done;){if(!r.value.check(t,i))return!1}}catch(s){n.e(s)}finally{n.f()}var a,o=_createForOfIteratorHelper(e.weakRequirements);try{for(o.s();!(a=o.n()).done;){if(!a.value.check(t,i))return!1}}catch(s){o.e(s)}finally{o.f()}return!0}(e,this.player,this)}},{key:"getAvailableProducts",value:function(e){var t,i=[],r=_createForOfIteratorHelper(e);try{for(r.s();!(t=r.n()).done;){var n,a=t.value,o=!0,s=_createForOfIteratorHelper(a.strongRequirements);try{for(s.s();!(n=s.n()).done;){if(!n.value.check(this.player,this)){o=!1;break}}}catch(l){s.e(l)}finally{s.f()}o&&i.push(a)}}catch(l){r.e(l)}finally{r.f()}return i}},{key:"getDisabledProducts",value:function(e){var t,i=new Set,r=_createForOfIteratorHelper(e);try{for(r.s();!(t=r.n()).done;){var n,a=t.value,o=_createForOfIteratorHelper(a.weakRequirements);try{for(o.s();!(n=o.n()).done;){n.value.check(this.player,this)||i.add(a)}}catch(s){o.e(s)}finally{o.f()}}}catch(s){r.e(s)}finally{r.f()}return i}},{key:"updateProductsList",value:function(){var e=this;this.availableUnits=this.getAvailableProducts(we),this.disabledUnits=this.getDisabledProducts(this.availableUnits);var t=ke.filter((function(t){var i;return(null===(i=e.product)||void 0===i?void 0:i.productDefinition)!==t&&!e.buildings.includes(t)}));this.availableBuildings=this.getAvailableProducts(t),this.disabledBuildings=this.getDisabledProducts(this.availableBuildings),this.availableIdleProducts=be}},{key:"changeOwner",value:function(e){if(this.player!==e){var t=this.player;this.player=e;var i=Array.from(this.tiles),r=t.cities.indexOf(this);-1!==r&&(t.cities.splice(r,1),t.area.removeBulk(i)),e.cities.push(this),e.area.addBulk(i),e.updateYields(),t.updateYields(),e.exploreTiles(this.tiles),this.cancelProduction(),L.cities.add(this);var n,a=_createForOfIteratorHelper(this.tiles);try{for(a.s();!(n=a.n()).done;){var o=n.value;L.tiles.add(o)}}catch(s){a.e(s)}finally{a.f()}}}},{key:"turnsToGrow",get:function(){if(this.perTurn.food>=0){var e=this.getFoodToGrow()-this.totalFood;return Math.max(0,Math.ceil(e/this.perTurn.food))}return Math.max(0,Math.ceil(this.totalFood/this.perTurn.food)-1)}},{key:"turnsToProductionEnd",get:function(){return this.product?Math.ceil((this.product.productDefinition.productionCost-this.totalProduction)/this.yields.production):null}},{key:"turnsToExpand",get:function(){var e=this.getCultureToExpand()-this.totalCulture;return Math.ceil(e/this.perTurn.culture)}},{key:"freeTileWorkers",get:function(){return this.size-this.workedTiles.size}}]),e}(),Je=function(){function e(){_classCallCheck(this,e),this.cities=[],this.citiesMap=new Map,this.lastId=0}return _createClass(e,[{key:"spawn",value:function(e,t){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(e.city)return null;if(e.landForm===_.mountains||e.seaLevel!==P.none)return null;var r=new Ge(e,t);r.id=this.lastId++,r.size=1,r.name="City ".concat(r.id),r.tile=e,r.isCoastline=!!r.tile.neighbours.find((function(e){return e.seaLevel!==P.none})),this.cities.push(r),this.citiesMap.set(r.id,r);var n,a=_createForOfIteratorHelper(e.neighbours);try{for(a.s();!(n=a.n()).done;){var o=n.value;r.addTile(o)}}catch(d){a.e(d)}finally{a.f()}t.addCity(r),e.city=r,e.forest=!1,e.wetlands=!1,e.road=y.road,e.update();var s,l=_createForOfIteratorHelper(e.getTilesInRange(3));try{for(l.s();!(s=l.n()).done;){var u=s.value;u.sweetSpotValue=0}}catch(d){l.e(d)}finally{l.f()}return i&&r.optimizeYields(),t.updateCitiesWithoutProduction(),L.cities.add(r),r}},{key:"destroy",value:function(e){var t=this.cities.indexOf(e);-1!==t&&this.cities.splice(t,1),this.citiesMap.delete(e.id),-1!==(t=e.player.cities.indexOf(e))&&e.player.cities.splice(t,1),e.tile.city=null;var i,r=_createForOfIteratorHelper(e.tiles);try{for(r.s();!(i=r.n()).done;){var n=i.value;e.removeTile(n)}}catch(a){r.e(a)}finally{r.f()}L.citiesDestroyed.add(e.id)}},{key:"nextTurn",value:function(){var e,t=_createForOfIteratorHelper(this.cities);try{for(t.s();!(e=t.n()).done;){e.value.nextTurn()}}catch(i){t.e(i)}finally{t.f()}}}]),e}(),Ke=function(){function e(){_classCallCheck(this,e),this.id=0,this.tiles=new Set}return _createClass(e,[{key:"add",value:function(e){this.tiles.add(e),L.addAreaTiles(this.id,[e])}},{key:"addBulk",value:function(e){var t,i=_createForOfIteratorHelper(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this.tiles.add(r)}}catch(n){i.e(n)}finally{i.f()}L.addAreaTiles(this.id,e)}},{key:"remove",value:function(e){this.tiles.delete(e),L.removeAreaTiles(this.id,[e])}},{key:"removeBulk",value:function(e){var t,i=_createForOfIteratorHelper(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this.tiles.delete(r)}}catch(n){i.e(n)}finally{i.f()}L.removeAreaTiles(this.id,e)}}]),e}(),$e=function(){function e(){_classCallCheck(this,e),this.areas=[],this.areasMap=new Map,this.lastId=0}return _createClass(e,[{key:"make",value:function(){var e=new Ke;return e.id=this.lastId++,this.areas.push(e),this.areasMap.set(e.id,e),e}},{key:"destroy",value:function(e){this.areasMap.delete(e.id);var t=this.areas.indexOf(e);-1!==t&&this.areas.splice(t,1)}}]),e}(),Qe=function(){function e(){_classCallCheck(this,e),this.debug=new Ve,this.players=[],this.playersMap=new Map,this.activePlayerIndex=-1,this.humanPlayer=null,this.turn=1,this.areasManager=new $e,this.unitsManager=new Be,this.citiesManager=new Je}return _createClass(e,[{key:"start",value:function(){this.preprocessEntities(),this.activePlayerIndex=-1,this.nextPlayer()}},{key:"preprocessEntities",value:function(){var e,t=_createForOfIteratorHelper(this.players);try{for(t.s();!(e=t.n()).done;){var i=e.value;i.updateCitiesWithoutProduction(),i.updateUnitsWithoutOrders(),i.updateYields(),i.updateVisibleTiles()}}catch(r){t.e(r)}finally{t.f()}}},{key:"addPlayer",value:function(e){e.id=this.players.length,this.players.push(e),this.playersMap.set(e.id,e),this.trackedPlayer||(this.trackedPlayer=e)}},{key:"nextPlayer",value:function(){this.activePlayerIndex++,this.activePlayerIndex>=this.players.length&&(this.nextTurn(),this.activePlayerIndex=0),this.activePlayer.ai?(this.activePlayer.ai.nextTurn(),this.activePlayer!==this.trackedPlayer&&this.nextPlayer()):this.activePlayer!==this.trackedPlayer&&(this.trackedPlayer=this.activePlayer,L.trackedPlayer=this.trackedPlayer,L.setVisibleTiles(this.trackedPlayer.visibleTiles))}},{key:"nextTurn",value:function(){this.unitsManager.nextTurn(),this.citiesManager.nextTurn();var e,t=_createForOfIteratorHelper(this.players);try{for(t.s();!(e=t.n()).done;){e.value.nextTurn()}}catch(i){t.e(i)}finally{t.f()}this.turn++,L.turn=this.turn}},{key:"activePlayer",get:function(){return this.players[this.activePlayerIndex]}}]),e}(),Xe=function e(){var t;_classCallCheck(this,e),this.governmentSections=(_defineProperty(t={},_e.organization,Ue("government_organization_tribalism")),_defineProperty(t,_e.economics,Ue("government_economics_barter")),t)},Ze=[16711680,65280,255,16776960,65535,16711935,10066329,14540253,16493740,15120499,3769899,3043694,7624635,11229115,7952444,11975654,11975910],et=function(){function e(t,i){_classCallCheck(this,e),this.game=t,this.color=i,this.exploredTiles=new Set,this.visibleTiles=new Set,this.units=[],this.cities=[],this.citiesWithoutProduction=[],this.unitsWithoutOrders=[],this.yields={costs:Object.assign({},d),income:Object.assign({},d),total:Object.assign({},d),perTurn:Object.assign({},d)},this.area=this.game.areasManager.make(),this.ai=null,this.internalPolitics=new Xe}return _createClass(e,[{key:"exploreTiles",value:function(e){var t,i=_createForOfIteratorHelper(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this.exploredTiles.has(r)||(this.exploredTiles.add(r),this.id===this.game.trackedPlayer.id&&L.tilesExplored.add(r.id))}}catch(n){i.e(n)}finally{i.f()}}},{key:"showTiles",value:function(e){var t,i=_createForOfIteratorHelper(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this.visibleTiles.has(r)||(this.visibleTiles.add(r),this.id===this.game.trackedPlayer.id&&L.tilesShowedAdded.add(r.id))}}catch(n){i.e(n)}finally{i.f()}}},{key:"updateYields",value:function(){c(this.yields.income),c(this.yields.costs),c(this.yields.perTurn);var e,t,i,r=_createForOfIteratorHelper(this.cities);try{for(r.s();!(e=r.n()).done;){var n,a=e.value,o=_createForOfIteratorHelper(a.tiles);try{for(o.s();!(n=o.n()).done;){var s=n.value;s.city||(null!==s.improvement&&this.yields.costs.publicWorks++,null!==s.road&&this.yields.costs.publicWorks++)}}catch(l){o.e(l)}finally{o.f()}h(this.yields.income,a.yields)}}catch(l){r.e(l)}finally{r.f()}f(this.yields.perTurn,this.yields.income),(t=this.yields.perTurn).food-=(i=this.yields.costs).food,t.production-=i.production,t.culture-=i.culture,t.publicWorks-=i.publicWorks,this===this.game.trackedPlayer&&(L.trackedPlayerYields=this.yields)}},{key:"nextTurn",value:function(){this.updateYields(),h(this.yields.total,this.yields.perTurn),this.yields.total.publicWorks=Math.max(0,this.yields.total.publicWorks),this.updateCitiesWithoutProduction(),this.updateUnitsWithoutOrders(),this.updateVisibleTiles()}},{key:"updateVisibleTiles",value:function(){this.visibleTiles.clear();var e,t=_createForOfIteratorHelper(this.cities);try{for(t.s();!(e=t.n()).done;){var i,r=_createForOfIteratorHelper(e.value.tiles);try{for(r.s();!(i=r.n()).done;){var n=i.value;this.visibleTiles.add(n)}}catch(d){r.e(d)}finally{r.f()}}}catch(d){t.e(d)}finally{t.f()}var a,o=_createForOfIteratorHelper(this.units);try{for(o.s();!(a=o.n()).done;){var s,l=_createForOfIteratorHelper(a.value.getVisibleTiles());try{for(l.s();!(s=l.n()).done;){var u=s.value;this.visibleTiles.add(u)}}catch(d){l.e(d)}finally{l.f()}}}catch(d){o.e(d)}finally{o.f()}this===this.game.trackedPlayer&&L.setVisibleTiles(this.visibleTiles)}},{key:"updateCitiesWithoutProduction",value:function(){this.citiesWithoutProduction=this.cities.filter((function(e){return!e.product}))}},{key:"updateUnitsWithoutOrders",value:function(){this.unitsWithoutOrders=this.units.filter((function(e){return!e.order&&!e.parent&&e.actionPointsLeft}))}},{key:"addCity",value:function(e){this.cities.push(e)}}]),e}();function tt(e,t){var i=performance.now(),r=e.tile;if(r===t)return null;if(ue(e,e.tile,t)===le.none)return null;var n=new Set,a=new Map,o=new Map,s=new Map,l=1/e.definition.actionPoints;for(a.set(r,0),s.set(r,0),o.set(r,[0,e.definition.actionPoints,null]);a.size;){var u,d=void 0,c=1/0,h=_createForOfIteratorHelper(a.entries());try{for(h.s();!(u=h.n()).done;){var f=_slicedToArray(u.value,2),p=f[0],y=f[1];y<c&&(c=y,d=p)}}catch(I){h.e(I)}finally{h.f()}var v=_toArray(o.get(d)),m=v[0],g=v[1];v.slice(2);if(g||(g=e.definition.actionPoints,m++),n.add(d),a.delete(d),d===t){var k=performance.now();return console.debug("pathfinding took ".concat((k-i).toFixed(3),"ms")),rt(o,t)}var b,w=_createForOfIteratorHelper(d.neighbours);try{for(w.s();!(b=w.n()).done;){var _=b.value;if(!n.has(_)){var P=ue(e,d,_);if(P===le.none)continue;if(P===le.attack&&_!==t)continue;var T=de(e,P,d,_),O=Math.max(0,g-T);T*=l,O||(T=1);var M=s.get(d)+T;(!s.has(_)||M<s.get(_))&&(s.set(_,M),a.set(_,M+it(_,t)*l),o.set(_,[m,O,d]))}}}catch(I){w.e(I)}finally{w.f()}}var C=performance.now();return console.debug("pathfinding took ".concat((C-i).toFixed(3),"ms")),null}function it(e,t){return Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))}function rt(e,t){for(var i=t,r=null,n=[t],a=[n];;){var o=_slicedToArray(e.get(i),3),s=o[0],l=(o[1],o[2]);if(!l||!e.has(l))return a;s!==r&&(r=s,n=[],a.unshift(n)),n.unshift(l),i=l}}var nt,at=function(){function e(t){_classCallCheck(this,e),this.player=t}return _createClass(e,[{key:"nextTurn",value:function(){var e,t=_createForOfIteratorHelper(this.player.unitsWithoutOrders);try{for(t.s();!(e=t.n()).done;){var i=e.value;i.order||(i.definition.actions.includes("foundCity")?this.processSettler(i):i.setOrder("sleep"))}}catch(o){t.e(o)}finally{t.f()}var r,n=_createForOfIteratorHelper(this.player.citiesWithoutProduction);try{for(n.s();!(r=n.n()).done;){var a=r.value;a.updateProductsList(),a.product||this.produceNext(a)}}catch(o){n.e(o)}finally{n.f()}}},{key:"processSettler",value:function(e){var t=e.getPathDestination();if(!t||t.areaOf){var i=this.findCityLocation(e.tile);if(!i)return void(e.order="sleep");e.tile===i?e.doAction("foundCity"):e.path=tt(e,i)}e.path&&fe(e)}},{key:"produceNext",value:function(e){var t=je("unit_settler");if(Math.random()>.7&&e.canProduce(t)&&this.findCityLocation(e.tile))e.produceUnit(t);else{var i=e.availableBuildings.filter((function(t){return!e.disabledBuildings.has(t)}));i.length?e.produceBuilding(i[0]):e.workOnIdleProduct(Ye("idle_product_culture"))}}},{key:"findCityLocation",value:function(e){var t,i=0,r=null,n=_createForOfIteratorHelper(e.getTilesInRange(5));try{for(n.s();!(t=n.n()).done;){var a=t.value;e.passableArea===a.passableArea&&a.sweetSpotValue>i&&(i=a.sweetSpotValue,r=a)}}catch(o){n.e(o)}finally{n.f()}return r}}]),e}();function ot(e){for(var t=[],i={},r=0;r<e.width;r++)for(var n=0;n<e.height;n++){var a=e.tiles[r][n],o={};a.seaLevel!==i.seaLevel&&(o.seaLevel=a.seaLevel),a.climate!==i.climate&&(o.climate=a.climate),a.landForm!==i.landForm&&(o.landForm=a.landForm),a.forest!==i.forest&&(o.forest=a.forest),a.wetlands!==i.wetlands&&(o.wetlands=a.wetlands),a.improvement!==i.improvement&&(o.improvement=a.improvement),a.road!==i.road&&(o.road=a.road),a.riverParts.length&&(o.riverParts=a.riverParts),t.push(o),i=a}return t}function st(e,t){var i=new et(e,t.color||0);t.ai&&(i.ai=new at(i));var r,n=_createForOfIteratorHelper(t.exploredTiles);try{for(n.s();!(r=n.n()).done;){var a=r.value;i.exploredTiles.add(e.map.tilesMap.get(a))}}catch(o){n.e(o)}finally{n.f()}return i.yields.total=t.yieldsTotal,i.updateYields(),i}function lt(e,t){var i=e.map.tilesMap.get(t.tile),r=e.citiesManager.spawn(i,e.players[t.player],!1);if(r){r.name=t.name,r.size=t.size,r.totalFood=t.totalFood,r.totalProduction=t.totalProduction,r.totalCulture=t.totalCulture;var n,a=_createForOfIteratorHelper(t.tiles);try{for(a.s();!(n=a.n()).done;){var o=n.value;r.addTile(e.map.tilesMap.get(o))}}catch(c){a.e(c)}finally{a.f()}var s,l,u=_createForOfIteratorHelper(t.workedTiles);try{for(u.s();!(s=u.n()).done;){var d=s.value;r.workTile(e.map.tilesMap.get(d))}}catch(c){u.e(c)}finally{u.f()}if(t.product)l="unit"===t.product.type?je(t.product.id):"building"===t.product.type?ze(t.product.id):Ye(t.product.id),r.product={type:t.product.type,productDefinition:l};r.buildings=t.buildings.map((function(e){return ze(e)})),r.buildingsIds=new Set(r.buildings.map((function(e){return e.id}))),r.updateYields()}}function ut(e,t){var i,r=e.map.tilesMap.get(t.tile),n=e.unitsManager.spawn(t.definition,r,e.players[t.player]);n.actionPointsLeft=t.actionPointsLeft,n.health=t.health,n.order=t.order,n.path=(null===(i=t.path)||void 0===i?void 0:i.map((function(t){return t.map((function(t){return e.map.tilesMap.get(t)}))})))||null}var dt={"game.new":function(e){nt=new Qe;for(var t=0;t<e.humanPlayersCount+e.aiPlayersCount;t++){var i=new et(nt,Ze[t]);t>=e.humanPlayersCount&&(i.ai=new at(i)),nt.addPlayer(i)}var r=new V(nt.players.length);nt.map=r.generate(e.width,e.height,e.seed,e.uniformity,e.seaLevel),nt.map.precompute();for(var n=0;n<nt.players.length;n++){var a=r.getStartingLocations()[n];nt.unitsManager.spawn("unit_settler",a,nt.players[n]),nt.unitsManager.spawn("unit_scout",a,nt.players[n]),nt.unitsManager.spawn("unit_warrior",a,nt.players[n])}return nt.start(),I(nt)},"game.saveDump":function(){return JSON.stringify({turn:(e=nt).turn,trackedPlayerId:e.trackedPlayer.id,activePlayerIndex:e.activePlayerIndex,map:(t=e.map,{width:t.width,height:t.height,tiles:ot(t)}),players:e.players.map((function(e){return{id:(t=e).id,ai:!!t.ai,color:t.color,exploredTiles:Array.from(t.exploredTiles).map((function(e){return e.id})),yieldsTotal:t.yields.total};var t})),units:e.unitsManager.units.map((function(e){return{id:(t=e).id,tile:t.tile.id,definition:t.definition.id,actionPointsLeft:t.actionPointsLeft,health:t.health,player:t.player.id,order:t.order,path:(null===(i=t.path)||void 0===i?void 0:i.map((function(e){return e.map((function(e){return e.id}))})))||null,parent:t.parent?t.parent.id:null};var t,i})),cities:e.citiesManager.cities.map((function(e){return{id:(t=e).id,name:t.name,size:t.size,player:t.player.id,tile:t.tile.id,totalFood:t.totalFood,totalProduction:t.totalProduction,totalCulture:t.totalCulture,product:t.product?{type:t.product.type,id:t.product.productDefinition.id}:null,tiles:Array.from(t.tiles).map((function(e){return e.id})),workedTiles:Array.from(t.workedTiles).map((function(e){return e.id})),buildings:t.buildings.map((function(e){return e.id}))};var t}))});var e,t},"game.loadDump":function(e){return I(nt=function(e){var t=new Qe;t.turn=e.turn,t.map=function(e){for(var t=new Y(e.width,e.height),i=t.tiles[0][0],r=0,n=0;n<e.width;n++)for(var a=0;a<e.height;a++){var o=e.tiles[r],s=t.tiles[n][a];s.climate=void 0!==o.climate?o.climate:i.climate,s.seaLevel=void 0!==o.seaLevel?o.seaLevel:i.seaLevel,s.landForm=void 0!==o.landForm?o.landForm:i.landForm,s.improvement=void 0!==o.improvement?o.improvement:i.improvement,s.road=void 0!==o.road?o.road:i.road,s.riverParts=o.riverParts||[],s.forest=void 0!==o.forest?o.forest:i.forest,i=s,r++}return t.precompute(),t}(e.map);var i,r=_createForOfIteratorHelper(e.players);try{for(r.s();!(i=r.n()).done;){var n=st(t,i.value);t.addPlayer(n)}}catch(p){r.e(p)}finally{r.f()}t.activePlayerIndex=e.activePlayerIndex;var a,o=_createForOfIteratorHelper(e.units);try{for(o.s();!(a=o.n()).done;){ut(t,a.value)}}catch(p){o.e(p)}finally{o.f()}var s,l=_createForOfIteratorHelper(e.units);try{for(l.s();!(s=l.n()).done;){var u=s.value;if(u.parent){var d=t.unitsManager.unitsMap.get(u.parent),c=t.unitsManager.unitsMap.get(u.id);d&&c&&d.addChild(c)}}}catch(p){l.e(p)}finally{l.f()}var h,f=_createForOfIteratorHelper(e.cities);try{for(f.s();!(h=f.n()).done;){lt(t,h.value)}}catch(p){f.e(p)}finally{f.f()}return t.preprocessEntities(),t}(JSON.parse(e)))},"game.nextPlayer":function(){nt.nextPlayer()},"trackedPlayer.revealWorld":function(){for(var e=0;e<nt.map.width;e++)nt.trackedPlayer.exploreTiles(nt.map.tiles[e])},"trackedPlayer.set":function(e){var t=nt.players.find((function(t){return t.id===e}));if(t)return nt.trackedPlayer=t,A(nt.trackedPlayer)},"unit.spawn":function(e){var t=nt.map.tilesMap.get(e.tileId),i=nt.playersMap.get(e.playerId);t&&i&&nt.unitsManager.spawn(e.definitionId,t,i)},"unit.getDetails":function(e){var t=nt.unitsManager.unitsMap.get(e);return t?E(t):null},"unit.doAction":function(e){var t=nt.unitsManager.unitsMap.get(e.unitId);return t?(t.doAction(e.action),E(t)):null},"unit.setOrder":function(e){var t=nt.unitsManager.unitsMap.get(e.unitId);return t?(t.setOrder(e.order),E(t)):null},"unit.findPath":function(e){var t=nt.unitsManager.unitsMap.get(e.unitId),i=nt.map.tilesMap.get(e.destinationId);return t&&i?(t.path=tt(t,i),E(t)):null},"unit.disband":function(e){var t=nt.unitsManager.unitsMap.get(e);if(!t)return null;nt.unitsManager.destroy(t)},"unit.moveAlongPath":function(e){var t=nt.unitsManager.unitsMap.get(e);return t?(fe(t),E(t)):null},"unit.getRange":function(e){var t=nt.unitsManager.unitsMap.get(e);if(!t)return[];var i=t.getRange();return Array.from(i).map((function(e){return e.id}))},"unit.getFailedActionRequirements":function(e){var t=nt.unitsManager.unitsMap.get(e.unitId);return t?t.getFailedActionRequirements(e.action):[]},"unit.simulateCombat":function(e){var t=nt.unitsManager.unitsMap.get(e.attackerId),i=nt.unitsManager.unitsMap.get(e.defenderId);return t&&i?ne(t,i):null},"tile.update":ct,"tile.bulkUpdate":ht,"city.getDetails":ft,"city.produce":pt,"city.getRange":yt,"city.getWorkTiles":vt,"city.workTile":mt,"city.unworkTile":gt,"city.optimizeYields":kt,"area.getTiles":bt,"entity.getFailedWeakRequirements":wt};function ct(e){var t=nt.map.tilesMap.get(e.id);t&&(Object.assign(t,e),t.update())}function ht(e){var t,i=_createForOfIteratorHelper(e);try{for(i.s();!(t=i.n()).done;){ct(t.value)}}catch(r){i.e(r)}finally{i.f()}}function ft(e){var t=nt.citiesManager.citiesMap.get(e);if(t)return W(t)}function pt(e){var t=nt.citiesManager.citiesMap.get(e.cityId);if(t)return"building"===e.type?t.produceBuilding(ze(e.productId)):"unit"===e.type?t.produceUnit(je(e.productId)):t.workOnIdleProduct(Ye(e.productId)),W(t)}function yt(e){var t=nt.citiesManager.citiesMap.get(e);if(t)return Array.from(t.tiles).map((function(e){return e.id}))}function vt(e){var t=nt.citiesManager.citiesMap.get(e);return t?{workedTiles:Array.from(t.workedTiles).map((function(e){return e.id})),notWorkedTiles:Array.from(t.notWorkedTiles).map((function(e){return e.id}))}:{}}function mt(e){var t=nt.citiesManager.citiesMap.get(e.cityId),i=nt.map.tilesMap.get(e.tileId);return t&&i?(t.workTile(i),W(t)):null}function gt(e){var t=nt.citiesManager.citiesMap.get(e.cityId),i=nt.map.tilesMap.get(e.tileId);return t&&i?(t.unworkTile(i),W(t)):null}function kt(e){var t=nt.citiesManager.citiesMap.get(e);return t?(t.optimizeYields(),W(t)):null}function bt(e){var t=nt.areasManager.areasMap.get(e);return t?Array.from(t.tiles).map((function(e){return e.id})):[]}function wt(e){var t=e.cityId,i=function(e){var t=Te.get(e);if(!t)throw Error('DataManager: No entity with id "'.concat(e,'"'));return t}(e.entityId);if(!i)return[];var r=null;return t&&(r=nt.citiesManager.citiesMap.get(t)),function(e,t,i){return e.weakRequirements.filter((function(e){return!e.check(t,i)})).map((function(e){return[e.id,e.context]}))}(i,nt.trackedPlayer,r)}addEventListener("message",(function(e){var t=e.data,i=dt[t.command];if(i){var r=i(t.data),n=L.flush();nt.trackedPlayer.updateCitiesWithoutProduction(),nt.trackedPlayer.updateUnitsWithoutOrders();var a,o=(a=nt.trackedPlayer).ai?null:a.citiesWithoutProduction.length?{task:"city",id:a.citiesWithoutProduction[0].id}:a.unitsWithoutOrders.length?{task:"unit",id:a.unitsWithoutOrders[0].id}:null;postMessage({result:r,changes:n,nextTask:o})}else console.error('No handler for command "'.concat(t.command,'".'))}))}});