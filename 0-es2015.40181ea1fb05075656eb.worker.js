!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,(function(e){return t[e]}).bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s="OO65")}({Fu16:function(t,e,i){var s;!function(){"use strict";var n=.5*(Math.sqrt(3)-1),r=(3-Math.sqrt(3))/6,o=(Math.sqrt(5)-1)/4,a=(5-Math.sqrt(5))/20;function l(t){var e;e="function"==typeof t?t:t?function(){var t=0,e=0,i=0,s=1,n=u();t=n(" "),e=n(" "),i=n(" ");for(var r=0;r<arguments.length;r++)(t-=n(arguments[r]))<0&&(t+=1),(e-=n(arguments[r]))<0&&(e+=1),(i-=n(arguments[r]))<0&&(i+=1);return n=null,function(){var n=2091639*t+2.3283064365386963e-10*s;return t=e,e=i,i=n-(s=0|n)}}(t):Math.random,this.p=d(e),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(var i=0;i<512;i++)this.perm[i]=this.p[255&i],this.permMod12[i]=this.perm[i]%12}function d(t){var e,i=new Uint8Array(256);for(e=0;e<256;e++)i[e]=e;for(e=0;e<255;e++){var s=e+~~(t()*(256-e)),n=i[e];i[e]=i[s],i[s]=n}return i}function u(){var t=4022871197;return function(e){e=e.toString();for(var i=0;i<e.length;i++){var s=.02519603282416938*(t+=e.charCodeAt(i));s-=t=s>>>0,t=(s*=t)>>>0,t+=4294967296*(s-=t)}return 2.3283064365386963e-10*(t>>>0)}}l.prototype={grad3:new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),grad4:new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),noise2D:function(t,e){var i,s,o=this.permMod12,a=this.perm,l=this.grad3,d=0,u=0,c=0,h=(t+e)*n,p=Math.floor(t+h),f=Math.floor(e+h),m=(p+f)*r,g=t-(p-m),y=e-(f-m);g>y?(i=1,s=0):(i=0,s=1);var v=g-i+r,w=y-s+r,b=g-1+2*r,P=y-1+2*r,T=255&p,M=255&f,k=.5-g*g-y*y;if(k>=0){var x=3*o[T+a[M]];d=(k*=k)*k*(l[x]*g+l[x+1]*y)}var W=.5-v*v-w*w;if(W>=0){var S=3*o[T+i+a[M+s]];u=(W*=W)*W*(l[S]*v+l[S+1]*w)}var O=.5-b*b-P*P;if(O>=0){var E=3*o[T+1+a[M+1]];c=(O*=O)*O*(l[E]*b+l[E+1]*P)}return 70*(d+u+c)},noise3D:function(t,e,i){var s,n,r,o,a,l,d,u,c,h,p=this.permMod12,f=this.perm,m=this.grad3,g=(t+e+i)*(1/3),y=Math.floor(t+g),v=Math.floor(e+g),w=Math.floor(i+g),b=(y+v+w)*(1/6),P=t-(y-b),T=e-(v-b),M=i-(w-b);P>=T?T>=M?(a=1,l=0,d=0,u=1,c=1,h=0):P>=M?(a=1,l=0,d=0,u=1,c=0,h=1):(a=0,l=0,d=1,u=1,c=0,h=1):T<M?(a=0,l=0,d=1,u=0,c=1,h=1):P<M?(a=0,l=1,d=0,u=0,c=1,h=1):(a=0,l=1,d=0,u=1,c=1,h=0);var k=P-a+1/6,x=T-l+1/6,W=M-d+1/6,S=P-u+1/6*2,O=T-c+1/6*2,E=M-h+1/6*2,C=P-1+.5,R=T-1+.5,L=M-1+.5,F=255&y,A=255&v,I=255&w,N=.6-P*P-T*T-M*M;if(N<0)s=0;else{var q=3*p[F+f[A+f[I]]];s=(N*=N)*N*(m[q]*P+m[q+1]*T+m[q+2]*M)}var _=.6-k*k-x*x-W*W;if(_<0)n=0;else{var D=3*p[F+a+f[A+l+f[I+d]]];n=(_*=_)*_*(m[D]*k+m[D+1]*x+m[D+2]*W)}var z=.6-S*S-O*O-E*E;if(z<0)r=0;else{var Y=3*p[F+u+f[A+c+f[I+h]]];r=(z*=z)*z*(m[Y]*S+m[Y+1]*O+m[Y+2]*E)}var j=.6-C*C-R*R-L*L;if(j<0)o=0;else{var B=3*p[F+1+f[A+1+f[I+1]]];o=(j*=j)*j*(m[B]*C+m[B+1]*R+m[B+2]*L)}return 32*(s+n+r+o)},noise4D:function(t,e,i,s){var n,r,l,d,u,c,h,p,f,m,g,y,v,w,b,P,T,M=this.perm,k=this.grad4,x=(t+e+i+s)*o,W=Math.floor(t+x),S=Math.floor(e+x),O=Math.floor(i+x),E=Math.floor(s+x),C=(W+S+O+E)*a,R=t-(W-C),L=e-(S-C),F=i-(O-C),A=s-(E-C),I=0,N=0,q=0,_=0;R>L?I++:N++,R>F?I++:q++,R>A?I++:_++,L>F?N++:q++,L>A?N++:_++,F>A?q++:_++;var D=R-(c=I>=3?1:0)+a,z=L-(h=N>=3?1:0)+a,Y=F-(p=q>=3?1:0)+a,j=A-(f=_>=3?1:0)+a,B=R-(m=I>=2?1:0)+2*a,V=L-(g=N>=2?1:0)+2*a,U=F-(y=q>=2?1:0)+2*a,G=A-(v=_>=2?1:0)+2*a,$=R-(w=I>=1?1:0)+3*a,H=L-(b=N>=1?1:0)+3*a,J=F-(P=q>=1?1:0)+3*a,K=A-(T=_>=1?1:0)+3*a,Q=R-1+4*a,X=L-1+4*a,Z=F-1+4*a,tt=A-1+4*a,et=255&W,it=255&S,st=255&O,nt=255&E,rt=.6-R*R-L*L-F*F-A*A;if(rt<0)n=0;else{var ot=M[et+M[it+M[st+M[nt]]]]%32*4;n=(rt*=rt)*rt*(k[ot]*R+k[ot+1]*L+k[ot+2]*F+k[ot+3]*A)}var at=.6-D*D-z*z-Y*Y-j*j;if(at<0)r=0;else{var lt=M[et+c+M[it+h+M[st+p+M[nt+f]]]]%32*4;r=(at*=at)*at*(k[lt]*D+k[lt+1]*z+k[lt+2]*Y+k[lt+3]*j)}var dt=.6-B*B-V*V-U*U-G*G;if(dt<0)l=0;else{var ut=M[et+m+M[it+g+M[st+y+M[nt+v]]]]%32*4;l=(dt*=dt)*dt*(k[ut]*B+k[ut+1]*V+k[ut+2]*U+k[ut+3]*G)}var ct=.6-$*$-H*H-J*J-K*K;if(ct<0)d=0;else{var ht=M[et+w+M[it+b+M[st+P+M[nt+T]]]]%32*4;d=(ct*=ct)*ct*(k[ht]*$+k[ht+1]*H+k[ht+2]*J+k[ht+3]*K)}var pt=.6-Q*Q-X*X-Z*Z-tt*tt;if(pt<0)u=0;else{var ft=M[et+1+M[it+1+M[st+1+M[nt+1]]]]%32*4;u=(pt*=pt)*pt*(k[ft]*Q+k[ft+1]*X+k[ft+2]*Z+k[ft+3]*tt)}return 27*(n+r+l+d+u)}},l._buildPermutationTable=d,void 0===(s=(function(){return l}).call(e,i,e,t))||(t.exports=s),e.SimplexNoise=l,t.exports=l}()},OO65:function(t,e,i){"use strict";i.r(e),i.d(e,"tileUpdate",(function(){return jt})),i.d(e,"tileBulkUpdate",(function(){return Bt})),i.d(e,"getCityDetails",(function(){return Vt})),i.d(e,"cityProduce",(function(){return Ut})),i.d(e,"cityGetRange",(function(){return Gt})),i.d(e,"cityGetWorkTiles",(function(){return $t})),i.d(e,"cityWorkTile",(function(){return Ht})),i.d(e,"cityUnworkTile",(function(){return Jt})),i.d(e,"cityOptimizeYields",(function(){return Kt})),i.d(e,"getAreaTiles",(function(){return Qt})),i.d(e,"entityGetFailedWeakRequirements",(function(){return Xt}));var s=i("Fu16");const n={food:0,production:0,culture:0,publicWorks:0};function r(t){t.food=0,t.production=0,t.culture=0,t.publicWorks=0}function o(t,e){t.food+=e.food,t.production+=e.production,t.culture+=e.culture,t.publicWorks+=e.publicWorks}function a(t,e){t.food=e.food,t.production=e.production,t.culture=e.culture,t.publicWorks=e.publicWorks}var l=function(t){return t[t.farm=0]="farm",t[t.mine=1]="mine",t[t.sawmill=2]="sawmill",t}({}),d=function(t){return t[t.road=0]="road",t}({});const u={[l.farm]:15,[l.mine]:15,[l.sawmill]:15},c={[l.farm]:1,[l.mine]:1,[l.sawmill]:1},h={[d.road]:15},p={[d.road]:1};var f=function(t){return t[t.NW=0]="NW",t[t.NE=1]="NE",t[t.E=2]="E",t[t.SE=3]="SE",t[t.SW=4]="SW",t[t.W=5]="W",t[t.NONE=6]="NONE",t}({}),m=function(t){return t[t.tropical=0]="tropical",t[t.savanna=1]="savanna",t[t.desert=2]="desert",t[t.continental=3]="continental",t[t.oceanic=4]="oceanic",t[t.tundra=5]="tundra",t[t.arctic=6]="arctic",t}({}),g=function(t){return t[t.plains=0]="plains",t[t.hills=1]="hills",t[t.mountains=2]="mountains",t}({}),y=function(t){return t[t.none=0]="none",t[t.shallow=1]="shallow",t[t.deep=2]="deep",t}({});const v=new Set([m.continental,m.oceanic,m.tropical,m.tundra]),w=new Set([m.continental,m.oceanic,m.tropical]);function b(t){return t.seaLevel===y.none&&t.landForm===g.plains&&v.has(t.climate)}function P(t){return!(t.seaLevel!==y.none||t.landForm!==g.plains||!t.riverParts.length||!w.has(t.climate))}function T(t){return{turn:t.turn,map:M(t.map),players:t.players.map(t=>{return{id:(e=t).id,color:e.color,areaId:e.area.id};var e}),trackedPlayer:S(t.trackedPlayer),units:t.unitsManager.units.map(t=>O(t)),cities:t.citiesManager.cities.map(t=>x(t))}}function M(t){const e=[];for(let i=0;i<t.width;i++){const s=[];e.push(s);for(let e=0;e<t.height;e++)s.push(k(t.tiles[i][e]))}return{width:t.width,height:t.height,tiles:e}}function k(t){return{id:t.id,x:t.x,y:t.y,climate:t.climate,forest:t.forest,improvement:t.improvement,landForm:t.landForm,riverParts:t.riverParts,road:t.road,seaLevel:t.seaLevel,wetlands:t.wetlands,yields:t.yields,areaOf:t.areaOf?t.areaOf.id:null,unitsIds:t.units.map(t=>t.id),cityId:t.city?t.city.id:null}}function x(t){return{id:t.id,name:t.name,size:t.size,playerId:t.player.id,tileId:t.tile.id,totalFood:t.totalFood,foodToGrow:t.getFoodToGrow(),foodPerTurn:t.perTurn.food,turnsToGrow:t.turnsToGrow,totalProduction:t.totalProduction,productionPerTurn:t.yields.production,productionRequired:t.product?t.product.productDefinition.productionCost:null,turnsToProductionEnd:t.turnsToProductionEnd,productName:t.product?t.product.productDefinition.name:null}}function W(t){var e,i;return t.updateProductsList(),{id:t.id,name:t.name,size:t.size,playerId:t.player.id,tileId:t.tile.id,totalFood:t.totalFood,foodToGrow:t.getFoodToGrow(),turnsToGrow:t.turnsToGrow,totalProduction:t.totalProduction,turnsToProductionEnd:t.turnsToProductionEnd,availableBuildings:t.availableBuildings.map(t=>t.id),availableIdleProducts:t.availableIdleProducts.map(t=>t.id),availableUnits:t.availableUnits.map(t=>t.id),buildingsIds:Array.from(t.buildingsIds),cultureToExpand:t.getCultureToExpand(),disabledBuildings:Array.from(t.disabledBuildings).map(t=>t.id),disabledIdleProducts:Array.from(t.disabledIdleProducts).map(t=>t.id),disabledUnits:Array.from(t.disabledUnits).map(t=>t.id),foodConsumed:t.foodConsumed,perTurn:t.perTurn,productId:(null===(e=t.product)||void 0===e?void 0:e.productDefinition.id)||null,productType:(null===(i=t.product)||void 0===i?void 0:i.type)||null,tileYields:t.tileYields,tiles:Array.from(t.tiles).map(t=>t.id),totalCulture:t.totalCulture,workedTiles:Array.from(t.workedTiles).map(t=>t.id),yields:t.yields}}function S(t){return{id:t.id,color:t.color,exploredTiles:Array.from(t.exploredTiles).map(t=>t.id),visibleTiles:Array.from(t.visibleTiles).map(t=>t.id),units:t.units.map(t=>t.id),cities:t.cities.map(t=>t.id),yields:t.yields}}function O(t){return{id:t.id,tileId:t.tile.id,definitionId:t.definition.id,playerId:t.player.id,health:t.health}}function E(t){var e;return{id:t.id,tileId:t.tile.id,definitionId:t.definition.id,playerId:t.player.id,actionPointsLeft:t.actionPointsLeft,health:t.health,order:t.order,path:(null===(e=t.path)||void 0===e?void 0:e.map(t=>t.map(t=>t.id)))||null}}const C=new class{constructor(){this.tiles=new Set,this.units=new Set,this.unitsDestroyed=new Set,this.cities=new Set,this.citiesDestroyed=new Set,this.areaTilesAdded=new Map,this.areaTilesRemoved=new Map,this.tilesExplored=new Set,this.tilesShowed=new Set,this.tilesShowedAdded=new Set,this.turn=0}flush(){const t=[];for(const e of this.units)t.push({type:"unit.updated",data:O(e)});for(const e of this.unitsDestroyed)t.push({type:"unit.destroyed",data:e});for(const e of this.cities)t.push({type:"city.updated",data:x(e)});for(const e of this.citiesDestroyed)t.push({type:"city.destroyed",data:e});this.tiles.size&&t.push({type:"tiles.updated",data:Array.from(this.tiles).map(t=>k(t))});for(const[e,i]of this.areaTilesAdded.entries())t.push({type:"area.tilesAdded",data:{id:e,tiles:i.map(t=>t.id)}});for(const[e,i]of this.areaTilesRemoved.entries())t.push({type:"area.tilesRemoved",data:{id:e,tiles:i.map(t=>t.id)}});return this.turn&&t.push({type:"game.turn",data:this.turn}),this.trackedPlayer&&t.push({type:"trackedPlayer.set",data:S(this.trackedPlayer)}),this.trackedPlayerYields&&t.push({type:"trackedPlayer.yields",data:this.trackedPlayerYields}),this.tilesExplored.size&&t.push({type:"trackedPlayer.tilesExplored",data:Array.from(this.tilesExplored)}),this.tilesShowed.size&&t.push({type:"trackedPlayer.tilesShowed",data:Array.from(this.tilesShowed)}),this.tilesShowedAdded.size&&t.push({type:"trackedPlayer.tilesShowedAdded",data:Array.from(this.tilesShowedAdded)}),this.tiles.clear(),this.unitsDestroyed.clear(),this.units.clear(),this.cities.clear(),this.citiesDestroyed.clear(),this.areaTilesAdded.clear(),this.areaTilesRemoved.clear(),this.trackedPlayer=void 0,this.tilesExplored.clear(),this.tilesShowed.clear(),this.tilesShowedAdded.clear(),this.turn=0,t}addAreaTiles(t,e){this.areaTilesAdded.has(t)?this.areaTilesAdded.get(t).push(...e):this.areaTilesAdded.set(t,e)}removeAreaTiles(t,e){this.areaTilesRemoved.has(t)?this.areaTilesRemoved.get(t).push(...e):this.areaTilesRemoved.set(t,e)}setVisibleTiles(t){for(const e of t)this.tilesShowed.add(e.id)}addVisibleTiles(t){for(const e of t)this.tilesShowedAdded.add(e.id)}},R={[m.arctic]:Object.assign({},n),[m.continental]:Object.assign(Object.assign({},n),{food:1,production:1}),[m.desert]:Object.assign({},n),[m.oceanic]:Object.assign(Object.assign({},n),{food:2,production:1}),[m.savanna]:Object.assign(Object.assign({},n),{food:1,production:1}),[m.tropical]:Object.assign(Object.assign({},n),{food:1}),[m.tundra]:Object.assign(Object.assign({},n),{production:1})},L={[g.plains]:Object.assign({},n),[g.hills]:Object.assign(Object.assign({},n),{food:-1}),[g.mountains]:Object.assign(Object.assign({},n),{food:-1/0,production:-5})};class F{constructor(t,e,i){this.id=t,this.x=e,this.y=i,this.climate=m.continental,this.landForm=g.plains,this.seaLevel=y.deep,this.riverParts=[],this.forest=!1,this.wetlands=!1,this.improvement=null,this.road=null,this.units=[],this.city=null,this.areaOf=null,this.yields=Object.assign({},n),this.ethnicity=new Map,this.neighbours=[],this.fullNeighbours=[],this.neighboursCosts=new Map,this.sweetSpotValue=0,this.passableArea=0}computeMovementCosts(){for(const t of this.neighbours){const e=this.getDirectionTo(t);let i=1;this.isLand!==t.isLand?i=this.city||t.city?1:1/0:t.landForm===g.mountains?i=1/0:t.landForm===g.hills?i=2:this.riverParts.includes(e)?i=3:this.riverParts.length&&t.riverParts.length&&(i=.5),t.road===d.road&&(i/=3),t.forest&&(i*=2),this.neighboursCosts.set(t,i)}}getDirectionTo(t){return t.x===this.x-(this.y%2?0:1)&&t.y===this.y-1?f.NW:t.x===this.x+(this.y%2?1:0)&&t.y===this.y-1?f.NE:t.x===this.x+1&&t.y===this.y?f.E:t.x===this.x+(this.y%2?1:0)&&t.y===this.y+1?f.SE:t.x===this.x-(this.y%2?0:1)&&t.y===this.y+1?f.SW:t.x===this.x-1&&t.y===this.y?f.W:f.NONE}getDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}computeYields(){if(this.seaLevel===y.deep)this.yields.food=0,this.yields.production=0;else if(this.seaLevel===y.shallow)this.yields.food=1,this.yields.production=0;else{const t=R[this.climate],e=L[this.landForm];this.yields.food=t.food+e.food,this.yields.production=t.production+e.production,this.forest&&(this.yields.food--,this.yields.production++),this.wetlands&&(this.yields.food--,this.yields.production--),this.riverParts.length&&(this.yields.food+=this.climate===m.desert?3:1),this.improvement===l.farm?this.yields.food++:(this.improvement===l.mine||this.improvement===l.sawmill)&&this.yields.production++,this.yields.food=Math.max(0,this.yields.food),this.yields.production=Math.max(0,this.yields.production)}}get totalYields(){return this.yields.food+this.yields.production}getTilesInRange(t){const e=new Set([this]);for(let i=0;i<t;i++){let t=new Set;for(const i of e)for(const e of i.neighbours)t.add(e);for(const i of t)e.add(i)}return e}computeSweetSpotValue(){if(this.sweetSpotValue=0,this.areaOf||this.landForm===g.mountains||this.seaLevel!==y.none)return;const t=this.getTilesInRange(3);for(const e of t)this.sweetSpotValue+=e.yields.food,this.sweetSpotValue+=e.yields.production}update(){this.computeYields(),this.computeMovementCosts();for(const t of this.neighbours)t.computeMovementCosts();C.tiles.add(this)}get isWater(){return this.seaLevel!==y.none}get isLand(){return!this.isWater}}function A(t,e,i){return[N(t,t[e][i],f.NW),N(t,t[e][i],f.NE),N(t,t[e][i],f.E),N(t,t[e][i],f.SE),N(t,t[e][i],f.SW),N(t,t[e][i],f.W)]}function I(t,e,i){return A(t,e,i).filter(t=>!!t)}function N(t,e,i){switch(i){case f.NW:return e.y%2==0&&0===e.x||0===e.y?null:t[e.x-(e.y%2?0:1)][e.y-1];case f.NE:return e.y%2&&e.x===t.length-1||0===e.y?null:t[e.x+(e.y%2?1:0)][e.y-1];case f.E:return e.x===t.length-1?null:t[e.x+1][e.y];case f.SE:return e.y%2&&e.x===t.length-1||e.y===t[e.x].length-1?null:t[e.x+(e.y%2?1:0)][e.y+1];case f.SW:return e.y%2==0&&0===e.x||e.y===t[e.x].length-1?null:t[e.x-(e.y%2?0:1)][e.y+1];case f.W:return 0===e.x?null:t[e.x-1][e.y]}return null}class q{constructor(t,e){this.width=t,this.height=e,this.tiles=[],this.tilesMap=new Map;for(let i=0;i<t;i++){const s=[];this.tiles.push(s);for(let n=0;n<e;n++){const e=new F(i*t+n,i,n);s.push(e),this.tilesMap.set(e.id,e)}}for(let i=0;i<t;i++)for(let t=0;t<e;t++)this.tiles[i][t].neighbours=I(this.tiles,i,t),this.tiles[i][t].fullNeighbours=A(this.tiles,i,t)}precompute(){for(let t=0;t<this.width;t++)for(let e=0;e<this.height;e++){const i=this.tiles[t][e];i.computeYields(),i.computeMovementCosts(),i.computeSweetSpotValue()}this.precomputePassableAreas()}precomputePassableAreas(){const t=new Set;let e=1;for(let i=0;i<this.width;i++)for(let s=0;s<this.height;s++){const n=this.tiles[i][s];t.has(n)||n.landForm!==g.mountains&&this.computePassableArea(n,e++,t)}}computePassableArea(t,e,i){const s=[t];for(i.add(t);s.length;){const t=s.shift();t.passableArea=e;for(const e of t.neighbours){if(i.has(e))continue;const n=t.seaLevel===y.none&&e.seaLevel===y.none,r=t.seaLevel!==y.none&&e.seaLevel!==y.none;e.landForm===g.mountains||!n&&!r||(i.add(e),s.push(e))}}}get(t,e){return t<0||t>=this.width||e<0||e>=this.height?null:this.tiles[t][e]}}const _={[f.NW]:[[f.NE,f.NW],[f.NONE,f.NE]],[f.NE]:[[f.E,f.NE],[f.NONE,f.E]],[f.E]:[[f.SE,f.E],[f.NONE,f.SE]],[f.SE]:[[f.SW,f.SE],[f.NONE,f.SW]],[f.SW]:[[f.W,f.SW],[f.NONE,f.W]],[f.W]:[[f.NW,f.W],[f.NONE,f.NW]],[f.NONE]:[[f.NONE,f.NONE],[f.NONE,f.NONE]]},D={[f.NW]:f.SE,[f.NE]:f.SW,[f.E]:f.W,[f.SE]:f.NW,[f.SW]:f.NE,[f.W]:f.E,[f.NONE]:f.NONE};class z{constructor(t){this.startingLocationsCount=t,this.startingLocations=[],this.riversSources=[],this.metadata=new Map}getStartingLocations(){return this.startingLocations}generate(t,e,i,s=.5,n=0){this.map=new q(t,e),this.width=t,this.height=e,this.seed=i,this.uniformity=s,this.seaLevel=n;for(let r=0;r<this.width;r++)for(let t=0;t<this.height;t++)this.metadata.set(this.map.tiles[r][t],{height:0,humidity:0,temperature:0});this.generateHeightmap(),this.generateMountainRanges(),this.generateTemperature(),this.generateHumidity();for(let r=0;r<this.width;r++)for(let t=0;t<this.height;t++){const e=this.map.tiles[r][t],i=this.metadata.get(e);i.height>1.3?e.landForm=g.mountains:i.height>.25&&(e.landForm=g.hills),e.climate=i.temperature<.2?i.temperature<.07?m.arctic:m.tundra:i.humidity<.1?m.desert:i.humidity<.3?m.savanna:i.humidity<.7&&i.temperature<.5?m.continental:i.temperature>.5?m.tropical:m.oceanic}for(const[r,o,a]of this.getNoisedTiles(new Y([[.015,1],[.06,1],[.3,1]],this.seed)))o+(r.climate===m.tropical?.3:0)>-.2&&b(r)&&(r.forest=!0);return this.fixShallowWater(),this.adjustHeightmap(),this.placeRivers(),this.placeWetlands(),this.findStartingPositions(),this.map}generateHeightmap(){const t=Math.max(this.width,this.height),e=Math.floor(Math.pow(t,.4)),i=[];for(let a=0;a<e;a++)i.push([Math.pow(.6,a+4),1+this.uniformity*a]);const s=i.reduce((t,e)=>t+e[1],0),n=s*this.seaLevel,r=new Y(i,this.seed),o=new Y([[.015,1],[.06,1],[.3,1]],this.seed);for(let[a,l,d]of this.getNoisedTiles(r)){let t=0;const e=Math.min(a.x,this.width-a.x),i=.1*this.width;e<i&&(l-=s/2*Math.cos(Math.PI/2/i*e)),l>n&&(t=l,a.seaLevel=y.none,l>.05&&Math.random()>.97&&this.riversSources.push(a),t=o.at(a.x,a.y)),this.metadata.get(a).height=t}}generateTemperature(){for(const[t,e,i]of this.getNoisedTiles(new Y([[.012,1],[.07,1]],this.seed))){const s=(1-i)/2,n=(e+1)/2*(1-i);this.metadata.get(t).temperature=Math.max(s,Math.min(1,s+n))}}generateHumidity(){for(const[t,e,i]of this.getNoisedTiles(new Y([[.025,1],[.2,1]],this.seed))){const s=10*i,n=s<1.5*Math.PI?(Math.cos(s)+1)/2-.5:0,r=(e+1)/2;this.metadata.get(t).humidity=Math.max(0,Math.min(1,.8*n+r))}}generateMountainRanges(){}*getNoisedTiles(t){for(let e=0;e<this.width;e++)for(let i=0;i<this.height;i++){const s=t.at(e,i),n=Math.floor(this.height/2),r=Math.abs((i-n)/n);yield[this.map.tiles[e][i],s,r]}}fixShallowWater(){for(let t=0;t<this.width;t++)for(let e=0;e<this.height;e++){const i=this.map.tiles[t][e];if(i.seaLevel===y.none)for(const t of i.neighbours)t.seaLevel===y.deep&&(t.seaLevel=y.shallow)}}adjustHeightmap(){let t=function(t){const e=[];for(let i=0;i<t.length;i++)for(let s=0;s<t[i].length;s++){const n=t[i][s];n.seaLevel===y.none&&n.neighbours.find(t=>t.seaLevel!==y.none)&&e.push(n)}return e}(this.map.tiles);const e=new Set,i=new Set(t);let s=0;for(;t.length;){s+=.7;for(const n of t)for(const t of n.neighbours)t.seaLevel!==y.none||i.has(t)||(i.add(t),e.add(t),this.metadata.get(t).height+=s);t=Array.from(e),e.clear()}}placeRivers(){for(const t of this.riversSources){if(t.riverParts.length)continue;let e=!0;for(const i of t.neighbours)i.seaLevel!==y.none&&(e=!1);e&&this.buildRiverPath(t,Math.round(5*Math.random()))}}buildRiverPath(t,e){if(e===f.NONE)return;const i=_[e].map(e=>e.map(e=>e===f.NONE?t:N(this.map.tiles,t,e))).filter(t=>t[0]&&t[1]&&t[0].seaLevel===y.none&&t[1].seaLevel===y.none&&t[0].riverParts.length<4&&t[1].riverParts.length<4);if(0===i.length)return;let s;if(1===i.length)s=i[0];else{const[t,e]=i;s=(this.metadata.get(t[0]).height+this.metadata.get(t[1]).height)/2<(this.metadata.get(e[0]).height+this.metadata.get(e[1]).height)/2?t:e}(function(t,e){const i=t.getDirectionTo(e);return!t.riverParts.includes(i)&&(t.riverParts.push(i),e.riverParts.push(D[i]),!0)})(...s)&&this.buildRiverPath(s[0],s[0].getDirectionTo(s[1]))}placeWetlands(){for(const[t,e,i]of this.getNoisedTiles(new Y([[.021,1],[.08,1],[.2,1]],this.seed)))e>0&&P(t)&&(t.wetlands=!0)}findStartingPositions(){let t=0;for(;t<1e4&&this.startingLocations.length<this.startingLocationsCount;){const e=Math.floor(Math.random()*this.width),i=Math.floor(Math.random()*this.height),s=this.map.tiles[e][i];s.seaLevel!==y.none||s.landForm===g.mountains||this.startingLocations.includes(s)||this.startingLocations.push(s),t++}}}class Y{constructor(t,e){this.scales=t,this.noises=t.map(()=>new s(e))}at(t,e){let i=0;for(let s=0;s<this.noises.length;s++){const[n,r]=this.scales[s];i+=this.noises[s].noise2D(t*n,e*n)*r}return i}}const j={buildFarm:l.farm,buildMine:l.mine,buildSawmill:l.sawmill};class B{constructor(){this.id=this.constructor.id}}class V extends B{constructor(){super(...arguments),this.id="ownTile"}check(t){var e;return(null===(e=t.tile.areaOf)||void 0===e?void 0:e.player)===t.player}}class U extends B{constructor(t){super(),this.improvement=t,this.id="sameImprovement"}check(t){return t.tile.improvement!==this.improvement}}class G extends B{constructor(t){super(),this.improvement=t,this.id="improvementPossible"}check(t){return e=t.tile,null===(i=this.improvement)||(i===l.farm?e.seaLevel===y.none&&e.landForm===g.plains&&e.climate!==m.arctic&&!e.forest&&!e.wetlands:i===l.mine?e.landForm===g.hills:i===l.sawmill&&e.forest&&!e.wetlands);var e,i}}class $ extends B{constructor(){super(...arguments),this.id="publicWorks"}check(t,e){return t.player.yields.total.publicWorks>=function(t){if("buildRoad"===t)return h[d.road];const e=j[t];return void 0!==e?u[e]:0}(e)}}function H(t,e,i){e.actionPointsLeft=0,e.tile.improvement=i,e.tile.update(),e.player.updateUnitsWithoutOrders(),e.player.yields.total.publicWorks-=u[i],e.player.yields.costs.publicWorks+=c[i],e.player.yields.perTurn.publicWorks-=c[i]}const J={foundCity:{action:"foundCity",name:"Found a city",fn:function(t,e){t.citiesManager.spawn(e.tile,e.player)&&t.unitsManager.destroy(e)},requirements:[new class extends B{constructor(){super(...arguments),this.id="notForeignTile"}check(t){var e;return!t.tile.areaOf||(null===(e=t.tile.areaOf)||void 0===e?void 0:e.player)===t.player}}]},buildFarm:{action:"buildFarm",name:"Build a farm",fn:(t,e)=>H(0,e,l.farm),requirements:[new V,new U(l.farm),new G(l.farm),new $]},buildMine:{action:"buildMine",name:"Build a mine",fn:(t,e)=>H(0,e,l.mine),requirements:[new V,new U(l.mine),new G(l.mine),new $]},buildSawmill:{action:"buildSawmill",name:"Build a sawmill",fn:(t,e)=>H(0,e,l.sawmill),requirements:[new V,new U(l.sawmill),new G(l.sawmill),new $]},buildRoad:{action:"buildRoad",name:"Build a road",fn:(t,e)=>function(t,e){e.actionPointsLeft=0,e.tile.road=d.road,e.tile.update();for(const i of e.tile.neighbours)i.update();e.player.updateUnitsWithoutOrders(),e.player.yields.total.publicWorks-=h[d.road],e.player.yields.costs.publicWorks+=p[d.road],e.player.yields.perTurn.publicWorks-=p[d.road]}(0,e),requirements:[new class extends B{constructor(){super(...arguments),this.id="noRoad"}check(t){return null===t.tile.road}},new class extends B{constructor(){super(...arguments),this.id="roadPossible"}check(t){return(e=t.tile).seaLevel===y.none&&e.landForm!==g.mountains;var e}},new $]}};var K=function(t){return t[t.hills=0]="hills",t[t.forest=1]="forest",t[t.river=2]="river",t[t.health=3]="health",t[t.flanks=4]="flanks",t}({}),Q=function(t){return t[t.victory=0]="victory",t[t.undecided=1]="undecided",t[t.defeat=2]="defeat",t}({});function X(t,e){const i=[...Z(t),...tt(t,e)],s=[...Z(e),...et(t,e)],n=t.definition.strength*i.reduce((t,e)=>t+e.value,1),r=e.definition.strength*s.reduce((t,e)=>t+e.value,1);return{attacker:{strength:n,modifiers:i,damage:it(r/n)},defender:{strength:r,modifiers:s,damage:it(n/r)}}}function Z(t){const e=[];return t.health<100&&e.push({type:K.health,value:(t.health-100)/200}),e}function tt(t,e){const i=[],s=st(t,e);return s&&i.push({type:K.flanks,value:.15*s}),i}function et(t,e){const i=[];e.tile.landForm===g.hills&&i.push({type:K.hills,value:.5}),e.tile.forest&&i.push({type:K.forest,value:.3});const s=e.tile.getDirectionTo(t.tile);e.tile.riverParts.includes(s)&&i.push({type:K.river,value:.5});const n=st(e,t);return n&&i.push({type:K.flanks,value:.15*n}),i}function it(t){let e=(Math.pow((t+3)/4,4)+1)/2;return Math.round(30*e)}function st(t,e){return e.tile.neighbours.filter(e=>!!e.units.find(e=>e.player===t.player&&e.definition.strength)).length-1}class nt{constructor(t,e,i,s){this.tile=t,this.definition=e,this.player=i,this.unitManager=s,this.health=100,this.order=null,this.actionPointsLeft=e.actionPoints}doAction(t){this.canDoAction(t)&&(J[t].fn(this.player.game,this),C.unitsDestroyed.has(this.id)||C.units.add(this))}canDoAction(t){if(!this.actionPointsLeft)return!1;if(!this.definition.actions.includes(t))return!1;for(const e of J[t].requirements)if(!e.check(this,t))return!1;return!0}getFailedActionRequirements(t){return J[t].requirements.filter(e=>!e.check(this,t)).map(t=>t.id)}setOrder(t){this.order=t,this.player.updateUnitsWithoutOrders()}getPathDestination(){if(!this.path)return null;const t=this.path[this.path.length-1];return t[t.length-1]}getRange(){const t=new Set,e=new Map;return this._getRange(this.tile,this.actionPointsLeft,t,e),1===t.size&&t.delete(this.tile),t}_getRange(t=this.tile,e=this.actionPointsLeft,i,s){if(i.add(t),e<=0)return i;for(const n of t.neighbours){const r=s.get(n);if("land"===this.definition.type&&!n.isLand)continue;if("naval"===this.definition.type&&!n.isWater&&!n.city)continue;const o=t.neighboursCosts.get(n);if(o===1/0)continue;const a=e-o;(!r||a>r)&&(s.set(n,a),this._getRange(n,a,i,s))}return i}destroy(){this.unitManager.destroy(this)}move(t){if(!this.actionPointsLeft)return;const e=this.getMovementCost(t);if(e===1/0)return;if(this.definition.strength)if(t.units.length){const e=t.units.find(t=>t.definition.strength&&t.player!==this.player);if(e&&(this.actionPointsLeft=Math.max(this.actionPointsLeft-3,0),function(t,e){const i=X(t,e);return t.health-=i.attacker.damage,e.health-=i.defender.damage,t.health>0&&C.units.add(t),e.health>0&&C.units.add(e),t.health<=0?(t.destroy(),Q.defeat):e.health<=0?(e.destroy(),Q.victory):Q.undecided}(this,e)!==Q.victory))return}else t.city&&t.city.player!==this.player&&t.city.changeOwner(this.player);const i=this.tile.units.indexOf(this);-1!==i&&this.tile.units.splice(i,1),t.units.push(this),this.tile=t,this.actionPointsLeft=Math.max(this.actionPointsLeft-e,0);const s=this.getVisibleTiles();this.player.exploreTiles(s),this.player.showTiles(s)}moveAlongPath(){if(this.path){for(this.setOrder(this.path.length?"go":null),C.units.add(this);this.actionPointsLeft&&this.path.length;)if(this.move(this.path[0][0]),this.path[0].shift(),this.path[0].length||this.path.shift(),!this.path.length)return this.path=null,void this.setOrder(null)}else this.setOrder(null)}getMovementCost(t){return this.tile.neighboursCosts.get(t)||1/0}getVisibleTiles(){return this.tile.getTilesInRange(2)}}class rt{constructor(){this.context={}}}class ot extends rt{constructor(t){super(),this.id="building",this.context={buildingId:t}}check(t,e){return!!e&&e.buildingsIds.has(this.context.buildingId)}}class at extends rt{constructor(t){super(),this.id="size",this.context={size:t}}check(t,e){return!!e&&e.size>=this.context.size}}const lt=[{id:"building_granary",name:"Granary",productionCost:40,bonuses:{yieldValue:{food:3}},strongRequirements:[],weakRequirements:[]},{id:"building_well",name:"Well",productionCost:20,bonuses:{yieldValue:{food:1}},strongRequirements:[],weakRequirements:[]},{id:"building_big_granary",name:"Grand granary",productionCost:100,bonuses:{yieldFactor:{food:.2}},strongRequirements:[new ot("building_granary")],weakRequirements:[]},{id:"building_workshop",name:"Workshop",productionCost:80,bonuses:{yieldValue:{production:5}},strongRequirements:[],weakRequirements:[]},{id:"building_big_workshop",name:"Grand workshop",productionCost:200,bonuses:{yieldFactor:{production:.2}},strongRequirements:[new ot("building_workshop")],weakRequirements:[]},{id:"building_slave_market",name:"Slave market",productionCost:50,bonuses:{yieldValue:{publicWorks:2}},strongRequirements:[],weakRequirements:[]},{id:"building_monument",name:"Monument",productionCost:30,bonuses:{yieldValue:{culture:2}},strongRequirements:[],weakRequirements:[]},{id:"building_all_doing_building",name:"All doing building",productionCost:500,bonuses:{yieldValue:{food:1,production:1},yieldFactor:{food:.1,production:.1}},strongRequirements:[new ot("building_big_granary"),new ot("building_big_workshop")],weakRequirements:[]}],dt=[{id:"idle_product_growth",name:"Growth",productionCost:1/0,strongRequirements:[],weakRequirements:[],bonuses:{transferProductionToFood:.25}},{id:"idle_product_culture",name:"Culture",productionCost:1/0,strongRequirements:[],weakRequirements:[],bonuses:{transferProductionToCulture:.25}},{id:"idle_product_public_works",name:"Public works",productionCost:1/0,strongRequirements:[],weakRequirements:[],bonuses:{transferProductionToPublicWorks:.25}}],ut=[{id:"unit_settler",name:"Settler",type:"land",actionPoints:2,strength:0,actions:["foundCity"],productionCost:50,strongRequirements:[],weakRequirements:[new ot("building_granary"),new at(3)]},{id:"unit_worker",name:"Worker",type:"land",actionPoints:2,strength:0,actions:["buildFarm","buildMine","buildSawmill","buildRoad"],productionCost:20,strongRequirements:[],weakRequirements:[new at(2)]},{id:"unit_scout",name:"Scout",type:"land",actionPoints:2,strength:2,actions:[],productionCost:10,strongRequirements:[],weakRequirements:[]},{id:"unit_warrior",name:"Warrior",type:"land",actionPoints:2,strength:5,actions:[],productionCost:30,strongRequirements:[],weakRequirements:[]},{id:"unit_tireme",name:"Tireme",type:"naval",actionPoints:3,strength:5,actions:[],productionCost:50,strongRequirements:[new class extends rt{constructor(){super(...arguments),this.id="coastlineCity"}check(t,e){return!!e&&!!e.tile.neighbours.find(t=>t.seaLevel!==y.none)}}],weakRequirements:[]}];var ct=function(t){return t[t.organization=0]="organization",t[t.economics=1]="economics",t}({});const ht=[{section:ct.organization,id:"government_organization_tribalism",name:"tribalism",bonuses:{culturePerKilledEnemy:.5},strongRequirements:[],weakRequirements:[]},{section:ct.organization,id:"government_organization_despotism",name:"despotism",bonuses:{},strongRequirements:[],weakRequirements:[]},{section:ct.economics,id:"government_economics_barter",name:"barter",bonuses:{},strongRequirements:[],weakRequirements:[]}],pt=new Map,ft=new Map;for(const Zt of ut)ft.set(Zt.id,Zt),pt.set(Zt.id,Zt);const mt=new Map;for(const Zt of lt)mt.set(Zt.id,Zt),pt.set(Zt.id,Zt);const gt=new Map;for(const Zt of dt)gt.set(Zt.id,Zt),pt.set(Zt.id,Zt);const yt=new Map;for(const Zt of ht)yt.set(Zt.id,Zt),pt.set(Zt.id,Zt);function vt(t){const e=ft.get(t);if(!e)throw Error(`DataManager: No unit with id "${t}"`);return e}function wt(t){const e=mt.get(t);if(!e)throw Error(`DataManager: No building with id "${t}"`);return e}function bt(t){const e=gt.get(t);if(!e)throw Error(`DataManager: No idle product with id "${t}"`);return e}function Pt(t){const e=yt.get(t);if(!e)throw Error(`DataManager: No government option with id "${t}"`);return e}class Tt{constructor(){this.units=[],this.unitsMap=new Map,this.lastId=0}spawn(t,e,i){const s=vt(t),n=new nt(e,s,i,this);return n.id=this.lastId++,this.units.push(n),this.unitsMap.set(n.id,n),i.units.push(n),e.units.push(n),n.player.exploreTiles(n.tile.getTilesInRange(2)),n.player.unitsWithoutOrders.push(n),C.units.add(n),n}destroy(t){this.unitsMap.delete(t.id);let e=this.units.indexOf(t);-1!==e&&this.units.splice(e,1),e=t.player.units.indexOf(t),-1!==e&&t.player.units.splice(e,1),e=t.tile.units.indexOf(t),-1!==e&&t.tile.units.splice(e,1),t.player.updateUnitsWithoutOrders(),C.unitsDestroyed.add(t.id)}nextTurn(){var t;for(const e of this.units)e.health<100&&(null===(t=e.tile.areaOf)||void 0===t?void 0:t.player)===e.player&&(e.health=Math.min(100,e.health+10),C.units.add(e)),e.path&&e.moveAlongPath(),"skip"===e.order&&e.setOrder(null),e.actionPointsLeft=e.definition.actionPoints}}class Mt{constructor(){this.revealMap=!1}}class kt{constructor(t,e){this.tile=t,this.player=e,this.totalFood=0,this.foodConsumed=1,this.totalCulture=0,this.tileYields=Object.assign({},n),this.yields=Object.assign({},n),this.perTurn=Object.assign({},n),this.product=null,this.totalProduction=0,this.buildings=[],this.buildingsIds=new Set,this.tiles=new Set,this.visibleTiles=new Set,this.workedTiles=new Set,this.notWorkedTiles=new Set,this.availableBuildings=[],this.disabledBuildings=new Set,this.availableUnits=[],this.disabledUnits=new Set,this.availableIdleProducts=[],this.disabledIdleProducts=new Set,this.changedSize=!1,this.addTile(t)}nextTurn(){this.changedSize=!1,this.progressExpansion(),this.progressProduction(),this.progressGrowth(),this.updateYields(),(this.player===this.player.game.trackedPlayer||this.changedSize)&&C.cities.add(this)}progressProduction(){this.product&&(this.totalProduction+=this.yields.production,this.totalProduction>=this.product.productDefinition.productionCost&&("unit"===this.product.type?this.player.game.unitsManager.spawn(this.product.productDefinition.id,this.tile,this.player):"building"===this.product.type&&(this.buildings.push(this.product.productDefinition),this.buildingsIds.add(this.product.productDefinition.id)),this.totalProduction=0,this.product=null))}progressGrowth(){this.totalFood+=this.yields.food-this.foodConsumed;const t=this.getFoodToGrow();if(this.totalFood>=t){this.size++,this.changedSize=!0;const e=this.pickBestTileToWork(this.notWorkedTiles);e&&this.workTile(e),this.totalFood-=t}else this.totalFood<0&&(this.size>1?(this.size--,this.changedSize=!0,this.totalFood+=t):this.totalFood=0)}progressExpansion(){this.totalCulture+=this.perTurn.culture;const t=this.getCultureToExpand();if(this.totalCulture>=t){this.totalCulture-=t;const e=this.pickBestTileToExpand(this.tile,this.getTilesAvailableForExpansion());e&&(this.addTile(e),e.sweetSpotValue=0)}}getCultureToExpand(){return Math.ceil(5*Math.pow(1.2,this.tiles.size))}getFoodToGrow(){return Math.ceil(15*Math.pow(1.2,this.size))}produceUnit(t){this.startProducing({type:"unit",productDefinition:t})}produceBuilding(t){this.canConstruct(t)&&this.startProducing({type:"building",productDefinition:t})}workOnIdleProduct(t){this.startProducing({type:"idleProduct",productDefinition:t}),this.updateYields(),this.player.updateYields()}cancelProduction(){if(this.product){const t=this.product.type;this.product=null,"idleProduct"===t&&(this.updateYields(),this.player.updateYields())}}startProducing(t){this.canProduce(t.productDefinition)&&(this.cancelProduction(),this.product=t,this.totalProduction=0,C.cities.add(this))}get turnsToGrow(){if(this.perTurn.food>=0){const t=this.getFoodToGrow()-this.totalFood;return Math.max(0,Math.ceil(t/this.perTurn.food))}return Math.max(0,Math.ceil(this.totalFood/this.perTurn.food)-1)}get turnsToProductionEnd(){return this.product?Math.ceil((this.product.productDefinition.productionCost-this.totalProduction)/this.yields.production):null}get turnsToExpand(){const t=this.getCultureToExpand()-this.totalCulture;return Math.ceil(t/this.perTurn.culture)}getTurnsToProduce(t){return Math.ceil(t.productionCost/this.yields.production)}updateYields(){var t,e;r(this.tileYields),this.tileYields.food=2,this.tileYields.production=1;for(const i of this.workedTiles)o(this.tileYields,i.yields);this.tileYields.production+=this.freeTileWorkers,a(this.yields,this.tileYields);for(const i of this.buildings)this.applyBonuses(i.bonuses);"idleProduct"===(null===(t=this.product)||void 0===t?void 0:t.type)&&this.applyBonuses(this.product.productDefinition.bonuses),(e=this.yields).food=Math.ceil(e.food),e.production=Math.ceil(e.production),e.culture=Math.ceil(e.culture),e.publicWorks=Math.ceil(e.publicWorks),this.foodConsumed=this.size,a(this.perTurn,this.yields),this.perTurn.food-=this.foodConsumed}applyBonuses(t){var e,i,s,n,r,o,a,l;this.yields.food+=(null===(e=t.yieldValue)||void 0===e?void 0:e.food)||0,this.yields.production+=(null===(i=t.yieldValue)||void 0===i?void 0:i.production)||0,this.yields.culture+=(null===(s=t.yieldValue)||void 0===s?void 0:s.culture)||0,this.yields.publicWorks+=(null===(n=t.yieldValue)||void 0===n?void 0:n.publicWorks)||0,(null===(r=t.yieldFactor)||void 0===r?void 0:r.food)&&(this.yields.food+=this.tileYields.food*t.yieldFactor.food),(null===(o=t.yieldFactor)||void 0===o?void 0:o.production)&&(this.yields.production+=this.tileYields.production*t.yieldFactor.production),(null===(a=t.yieldFactor)||void 0===a?void 0:a.culture)&&(this.yields.culture+=this.tileYields.culture*t.yieldFactor.culture),(null===(l=t.yieldFactor)||void 0===l?void 0:l.publicWorks)&&(this.yields.publicWorks+=this.tileYields.publicWorks*t.yieldFactor.publicWorks),t.transferProductionToFood&&(this.yields.food+=this.yields.production*t.transferProductionToFood),t.transferProductionToCulture&&(this.yields.culture+=this.yields.production*t.transferProductionToCulture),t.transferProductionToPublicWorks&&(this.yields.publicWorks+=this.yields.production*t.transferProductionToPublicWorks)}addTile(t){t.areaOf||(this.tiles.add(t),this.notWorkedTiles.add(t),t.areaOf=this,this.player.area.add(t),this.player.exploreTiles([t]),this.player.exploreTiles(t.neighbours),C.tiles.add(t))}removeTile(t){this.tiles.has(t)&&(this.tiles.delete(t),t.areaOf=null,this.player.area.remove(t),C.tiles.add(t))}workTile(t,e=!0){this.freeTileWorkers&&this.tiles.has(t)&&(this.workedTiles.add(t),this.notWorkedTiles.delete(t),e&&this.updateYields())}unworkTile(t,e=!0){this.workedTiles.delete(t),this.notWorkedTiles.add(t),e&&this.updateYields()}getTilesAvailableForExpansion(){const t=new Set;for(const e of this.tiles)for(const i of e.neighbours)i.areaOf||t.add(i);return t}pickBestTileToWork(t){let e=null,i=0;for(const s of t){const t=s.totalYields;t>i&&(i=t,e=s)}return e}pickBestTileToExpand(t,e){let i=null,s=-1/0;for(const n of e){const e=n.totalYields-t.getDistanceTo(n)/2;e>s&&(s=e,i=n)}return i}get freeTileWorkers(){return this.size-this.workedTiles.size}optimizeYields(){for(this.workedTiles.clear(),this.notWorkedTiles=new Set(this.tiles);this.freeTileWorkers&&this.notWorkedTiles.size;){const t=this.pickBestTileToWork(this.notWorkedTiles);if(!t)break;this.workTile(t,!1)}this.updateYields()}canConstruct(t){return!this.buildings.includes(t)}canProduce(t){return function(t,e,i){for(const s of t.strongRequirements)if(!s.check(e,i))return!1;for(const s of t.weakRequirements)if(!s.check(e,i))return!1;return!0}(t,this.player,this)}getAvailableProducts(t){const e=[];for(const i of t){let t=!0;for(const e of i.strongRequirements)if(!e.check(this.player,this)){t=!1;break}t&&e.push(i)}return e}getDisabledProducts(t){const e=new Set;for(const i of t)for(const t of i.weakRequirements)t.check(this.player,this)||e.add(i);return e}updateProductsList(){this.availableUnits=this.getAvailableProducts(ut),this.disabledUnits=this.getDisabledProducts(this.availableUnits);const t=lt.filter(t=>{var e;return(null===(e=this.product)||void 0===e?void 0:e.productDefinition)!==t&&!this.buildings.includes(t)});this.availableBuildings=this.getAvailableProducts(t),this.disabledBuildings=this.getDisabledProducts(this.availableBuildings),this.availableIdleProducts=dt}changeOwner(t){if(this.player===t)return;const e=this.player;this.player=t;const i=Array.from(this.tiles);let s=e.cities.indexOf(this);-1!==s&&(e.cities.splice(s,1),e.area.removeBulk(i)),t.cities.push(this),t.area.addBulk(i),t.updateYields(),e.updateYields(),t.exploreTiles(this.tiles),this.cancelProduction(),C.cities.add(this);for(const n of this.tiles)C.tiles.add(n)}}class xt{constructor(){this.cities=[],this.citiesMap=new Map,this.lastId=0}spawn(t,e,i=!0){if(t.city)return null;if(t.landForm===g.mountains||t.seaLevel!==y.none)return null;const s=new kt(t,e);s.id=this.lastId++,s.size=1,s.name=`City ${s.id}`,s.tile=t,this.cities.push(s),this.citiesMap.set(s.id,s);for(const n of t.neighbours)s.addTile(n);e.addCity(s),t.city=s,t.forest=!1,t.wetlands=!1,t.road=d.road,t.update();for(const n of t.getTilesInRange(3))n.sweetSpotValue=0;return i&&s.optimizeYields(),C.cities.add(s),s}destroy(t){let e=this.cities.indexOf(t);-1!==e&&this.cities.splice(e,1),this.citiesMap.delete(t.id),e=t.player.cities.indexOf(t),-1!==e&&t.player.cities.splice(e,1),t.tile.city=null;for(const i of t.tiles)t.removeTile(i);C.citiesDestroyed.add(t.id)}nextTurn(){for(const t of this.cities)t.nextTurn()}}class Wt{constructor(){this.id=0,this.tiles=new Set}add(t){this.tiles.add(t),C.addAreaTiles(this.id,[t])}addBulk(t){for(const e of t)this.tiles.add(e);C.addAreaTiles(this.id,t)}remove(t){this.tiles.delete(t),C.removeAreaTiles(this.id,[t])}removeBulk(t){for(const e of t)this.tiles.delete(e);C.removeAreaTiles(this.id,t)}}class St{constructor(){this.areas=[],this.areasMap=new Map,this.lastId=0}make(){const t=new Wt;return t.id=this.lastId++,this.areas.push(t),this.areasMap.set(t.id,t),t}destroy(t){this.areasMap.delete(t.id);const e=this.areas.indexOf(t);-1!==e&&this.areas.splice(e,1)}}class Ot{constructor(){this.debug=new Mt,this.players=[],this.playersMap=new Map,this.activePlayerIndex=-1,this.humanPlayer=null,this.turn=1,this.areasManager=new St,this.unitsManager=new Tt,this.citiesManager=new xt}start(){this.preprocessEntities(),this.activePlayerIndex=-1,this.nextPlayer()}preprocessEntities(){for(const t of this.players)t.updateCitiesWithoutProduction(),t.updateUnitsWithoutOrders(),t.updateYields(),t.updateVisibleTiles()}addPlayer(t){t.id=this.players.length,this.players.push(t),this.playersMap.set(t.id,t),this.trackedPlayer||(this.trackedPlayer=t)}nextPlayer(){this.activePlayerIndex++,this.activePlayerIndex>=this.players.length&&(this.nextTurn(),this.activePlayerIndex=0),this.activePlayer.ai?(this.activePlayer.ai.nextTurn(),this.nextPlayer()):this.trackedPlayer!==this.activePlayer&&(this.trackedPlayer=this.activePlayer,C.trackedPlayer=this.trackedPlayer,C.setVisibleTiles(this.trackedPlayer.visibleTiles))}nextTurn(){this.unitsManager.nextTurn(),this.citiesManager.nextTurn();for(const t of this.players)t.nextTurn();this.turn++,C.turn=this.turn}get activePlayer(){return this.players[this.activePlayerIndex]}}class Et{constructor(){this.governmentSections={[ct.organization]:Pt("government_organization_tribalism"),[ct.economics]:Pt("government_economics_barter")}}}const Ct=[16711680,65280,255,16776960,65535,16711935,10066329,14540253,16493740,15120499,3769899,3043694,7624635,11229115,7952444,11975654,11975910];class Rt{constructor(t,e){this.game=t,this.color=e,this.exploredTiles=new Set,this.visibleTiles=new Set,this.units=[],this.cities=[],this.citiesWithoutProduction=[],this.unitsWithoutOrders=[],this.yields={costs:Object.assign({},n),income:Object.assign({},n),total:Object.assign({},n),perTurn:Object.assign({},n)},this.area=this.game.areasManager.make(),this.ai=null,this.internalPolitics=new Et}exploreTiles(t){for(const e of t)this.exploredTiles.has(e)||(this.exploredTiles.add(e),this.id===this.game.trackedPlayer.id&&C.tilesExplored.add(e.id))}showTiles(t){for(const e of t)this.visibleTiles.has(e)||(this.visibleTiles.add(e),this.id===this.game.trackedPlayer.id&&C.tilesShowedAdded.add(e.id))}updateYields(){r(this.yields.income),r(this.yields.costs),r(this.yields.perTurn);for(const i of this.cities){for(const t of i.tiles)t.city||(null!==t.improvement&&this.yields.costs.publicWorks++,null!==t.road&&this.yields.costs.publicWorks++);o(this.yields.income,i.yields)}var t,e;a(this.yields.perTurn,this.yields.income),(t=this.yields.perTurn).food-=(e=this.yields.costs).food,t.production-=e.production,t.culture-=e.culture,t.publicWorks-=e.publicWorks,this===this.game.trackedPlayer&&(C.trackedPlayerYields=this.yields)}nextTurn(){this.updateYields(),o(this.yields.total,this.yields.perTurn),this.yields.total.publicWorks=Math.max(0,this.yields.total.publicWorks),this.updateCitiesWithoutProduction(),this.updateUnitsWithoutOrders(),this.updateVisibleTiles()}updateVisibleTiles(){this.visibleTiles.clear();for(const t of this.cities)for(const e of t.tiles)this.visibleTiles.add(e);for(const t of this.units)for(const e of t.getVisibleTiles())this.visibleTiles.add(e);this===this.game.trackedPlayer&&C.setVisibleTiles(this.visibleTiles)}updateCitiesWithoutProduction(){this.citiesWithoutProduction=this.cities.filter(t=>!t.product)}updateUnitsWithoutOrders(){this.unitsWithoutOrders=this.units.filter(t=>!t.order&&t.actionPointsLeft)}addCity(t){this.cities.push(t)}}function Lt(t,e){const i=performance.now(),s=t.tile;if(s===e)return null;if("naval"===t.definition.type){if(e.seaLevel===y.none&&!e.city)return null}else if(s.passableArea!==e.passableArea)return null;const n=new Set,r=new Map,o=new Map,a=new Map,l=1/t.definition.actionPoints;for(r.set(s,0),a.set(s,0),o.set(s,[0,t.definition.actionPoints,null]);r.size;){let s,d=1/0;for(const[t,e]of r.entries())e<d&&(d=e,s=t);let[u,c,...h]=o.get(s);if(c||(c=t.definition.actionPoints,u++),n.add(s),r.delete(s),s===e){const t=performance.now();return console.debug(`pathfinding took ${Math.round(t-i)}ms`),At(o,e)}for(const i of s.neighbours)if(!n.has(i)){let n=t.player.exploredTiles.has(i)?s.neighboursCosts.get(i):1;if(n===1/0)continue;if("naval"===t.definition.type&&i.seaLevel===y.none&&!i.city)continue;let d=Math.max(0,c-n);n*=l,d||(n=1);const h=a.get(s)+n;(!a.has(i)||h<a.get(i))&&(a.set(i,h),r.set(i,h+Ft(i,e)*l),o.set(i,[u,d,s]))}}const d=performance.now();return console.debug(`pathfinding took ${Math.round(d-i)}ms`),null}function Ft(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))}function At(t,e){let i=e,s=null,n=[e];const r=[n];for(;;){const[e,o,a]=t.get(i);if(!a||!t.has(a))return r;e!==s&&(s=e,n=[],r.unshift(n)),n.unshift(a),i=a}}class It{constructor(t){this.player=t}nextTurn(){for(const t of this.player.unitsWithoutOrders)t.order||t.definition.actions.includes("foundCity")&&this.processSettler(t);for(const t of this.player.citiesWithoutProduction)t.updateProductsList(),t.product||this.produceNext(t)}processSettler(t){const e=t.getPathDestination();if(!e||e.areaOf){const e=this.findCityLocation(t.tile);if(!e)return void(t.order="sleep");t.tile===e?t.doAction("foundCity"):t.path=Lt(t,e)}t.path&&t.moveAlongPath()}produceNext(t){const e=vt("unit_settler");if(Math.random()>.7&&t.canProduce(e)&&this.findCityLocation(t.tile))return void t.produceUnit(e);const i=t.availableBuildings.filter(e=>!t.disabledBuildings.has(e));i.length?t.produceBuilding(i[0]):t.workOnIdleProduct(bt("idle_product_culture"))}findCityLocation(t){const e=t.getTilesInRange(5);let i=0,s=null;for(const n of e)t.passableArea===n.passableArea&&n.sweetSpotValue>i&&(i=n.sweetSpotValue,s=n);return s}}function Nt(t){const e=[];let i={};for(let s=0;s<t.width;s++)for(let n=0;n<t.height;n++){const r=t.tiles[s][n],o={};r.seaLevel!==i.seaLevel&&(o.seaLevel=r.seaLevel),r.climate!==i.climate&&(o.climate=r.climate),r.landForm!==i.landForm&&(o.landForm=r.landForm),r.forest!==i.forest&&(o.forest=r.forest),r.wetlands!==i.wetlands&&(o.wetlands=r.wetlands),r.improvement!==i.improvement&&(o.improvement=r.improvement),r.road!==i.road&&(o.road=r.road),r.riverParts.length&&(o.riverParts=r.riverParts),e.push(o),i=r}return e}function qt(t,e){const i=new Rt(t,e.color||0);e.ai&&(i.ai=new It(i));for(const s of e.exploredTiles)i.exploredTiles.add(t.map.tilesMap.get(s));return i.yields.total=e.yieldsTotal,i.updateYields(),i}function _t(t,e){const i=t.map.tilesMap.get(e.tile),s=t.citiesManager.spawn(i,t.players[e.player],!1);if(s){s.name=e.name,s.size=e.size,s.totalFood=e.totalFood,s.totalProduction=e.totalProduction,s.totalCulture=e.totalCulture;for(const i of e.tiles)s.addTile(t.map.tilesMap.get(i));for(const i of e.workedTiles)s.workTile(t.map.tilesMap.get(i));if(e.product){let t;t="unit"===e.product.type?vt(e.product.id):"building"===e.product.type?wt(e.product.id):bt(e.product.id),s.product={type:e.product.type,productDefinition:t}}s.buildings=e.buildings.map(t=>wt(t)),s.buildingsIds=new Set(s.buildings.map(t=>t.id)),s.updateYields()}}function Dt(t,e){var i;const s=t.map.tilesMap.get(e.tile),n=t.unitsManager.spawn(e.definition,s,t.players[e.player]);n.actionPointsLeft=e.actionPointsLeft,n.health=e.health,n.order=e.order,n.path=(null===(i=e.path)||void 0===i?void 0:i.map(e=>e.map(e=>t.map.tilesMap.get(e))))||null}let zt;const Yt={"game.new":function(t){zt=new Ot;for(let i=0;i<t.humanPlayersCount+t.aiPlayersCount;i++){const e=new Rt(zt,Ct[i]);i>=t.humanPlayersCount&&(e.ai=new It(e)),zt.addPlayer(e)}const e=new z(zt.players.length);zt.map=e.generate(t.width,t.height,t.seed,t.uniformity,t.seaLevel),zt.map.precompute();for(let i=0;i<zt.players.length;i++){const t=e.getStartingLocations()[i];zt.unitsManager.spawn("unit_settler",t,zt.players[i]),zt.unitsManager.spawn("unit_scout",t,zt.players[i]),zt.unitsManager.spawn("unit_warrior",t,zt.players[i])}return zt.start(),T(zt)},"game.saveDump":function(){return JSON.stringify({turn:(t=zt).turn,trackedPlayerId:t.trackedPlayer.id,activePlayerIndex:t.activePlayerIndex,map:(e=t.map,{width:e.width,height:e.height,tiles:Nt(e)}),players:t.players.map(t=>{return{id:(e=t).id,ai:!!e.ai,color:e.color,exploredTiles:Array.from(e.exploredTiles).map(t=>t.id),yieldsTotal:e.yields.total};var e}),units:t.unitsManager.units.map(t=>{return{id:(e=t).id,tile:e.tile.id,definition:e.definition.id,actionPointsLeft:e.actionPointsLeft,health:e.health,player:e.player.id,order:e.order,path:(null===(i=e.path)||void 0===i?void 0:i.map(t=>t.map(t=>t.id)))||null};var e,i}),cities:t.citiesManager.cities.map(t=>{return{id:(e=t).id,name:e.name,size:e.size,player:e.player.id,tile:e.tile.id,totalFood:e.totalFood,totalProduction:e.totalProduction,totalCulture:e.totalCulture,product:e.product?{type:e.product.type,id:e.product.productDefinition.id}:null,tiles:Array.from(e.tiles).map(t=>t.id),workedTiles:Array.from(e.workedTiles).map(t=>t.id),buildings:e.buildings.map(t=>t.id)};var e})});var t,e},"game.loadDump":function(t){return zt=function(t){const e=new Ot;e.turn=t.turn,e.map=function(t){const e=new q(t.width,t.height);let i=e.tiles[0][0],s=0;for(let n=0;n<t.width;n++)for(let r=0;r<t.height;r++){const o=t.tiles[s],a=e.tiles[n][r];a.climate=void 0!==o.climate?o.climate:i.climate,a.seaLevel=void 0!==o.seaLevel?o.seaLevel:i.seaLevel,a.landForm=void 0!==o.landForm?o.landForm:i.landForm,a.improvement=void 0!==o.improvement?o.improvement:i.improvement,a.road=void 0!==o.road?o.road:i.road,a.riverParts=o.riverParts||[],a.forest=void 0!==o.forest?o.forest:i.forest,i=a,s++}return e.precompute(),e}(t.map);for(const i of t.players){const t=qt(e,i);e.addPlayer(t)}e.activePlayerIndex=t.activePlayerIndex;for(const i of t.units)Dt(e,i);for(const i of t.cities)_t(e,i);return e.preprocessEntities(),e}(JSON.parse(t)),T(zt)},"game.nextPlayer":function(){zt.nextPlayer()},"trackedPlayer.revealWorld":function(){for(let t=0;t<zt.map.width;t++)zt.trackedPlayer.exploreTiles(zt.map.tiles[t])},"trackedPlayer.set":function(t){const e=zt.players.find(e=>e.id===t);if(e)return zt.trackedPlayer=e,S(zt.trackedPlayer)},"unit.spawn":function(t){const e=zt.map.tilesMap.get(t.tileId),i=zt.playersMap.get(t.playerId);e&&i&&zt.unitsManager.spawn(t.definitionId,e,i)},"unit.getDetails":function(t){const e=zt.unitsManager.unitsMap.get(t);return e?E(e):null},"unit.doAction":function(t){const e=zt.unitsManager.unitsMap.get(t.unitId);return e?(e.doAction(t.action),E(e)):null},"unit.setOrder":function(t){const e=zt.unitsManager.unitsMap.get(t.unitId);return e?(e.setOrder(t.order),E(e)):null},"unit.findPath":function(t){const e=zt.unitsManager.unitsMap.get(t.unitId),i=zt.map.tilesMap.get(t.destinationId);return e&&i?(e.path=Lt(e,i),E(e)):null},"unit.disband":function(t){const e=zt.unitsManager.unitsMap.get(t);if(!e)return null;zt.unitsManager.destroy(e)},"unit.moveAlongPath":function(t){const e=zt.unitsManager.unitsMap.get(t);return e?(e.moveAlongPath(),E(e)):null},"unit.getRange":function(t){const e=zt.unitsManager.unitsMap.get(t);if(!e)return[];const i=e.getRange();return Array.from(i).map(t=>t.id)},"unit.getFailedActionRequirements":function(t){const e=zt.unitsManager.unitsMap.get(t.unitId);return e?e.getFailedActionRequirements(t.action):[]},"unit.simulateCombat":function(t){const e=zt.unitsManager.unitsMap.get(t.attackerId),i=zt.unitsManager.unitsMap.get(t.defenderId);return e&&i?X(e,i):null},"tile.update":jt,"tile.bulkUpdate":Bt,"city.getDetails":Vt,"city.produce":Ut,"city.getRange":Gt,"city.getWorkTiles":$t,"city.workTile":Ht,"city.unworkTile":Jt,"city.optimizeYields":Kt,"area.getTiles":Qt,"entity.getFailedWeakRequirements":Xt};function jt(t){const e=zt.map.tilesMap.get(t.id);e&&(Object.assign(e,t),e.update())}function Bt(t){for(const e of t)jt(e)}function Vt(t){const e=zt.citiesManager.citiesMap.get(t);if(e)return W(e)}function Ut(t){const e=zt.citiesManager.citiesMap.get(t.cityId);if(e)return"building"===t.type?e.produceBuilding(wt(t.productId)):"unit"===t.type?e.produceUnit(vt(t.productId)):e.workOnIdleProduct(bt(t.productId)),W(e)}function Gt(t){const e=zt.citiesManager.citiesMap.get(t);if(e)return Array.from(e.tiles).map(t=>t.id)}function $t(t){const e=zt.citiesManager.citiesMap.get(t);return e?{workedTiles:Array.from(e.workedTiles).map(t=>t.id),notWorkedTiles:Array.from(e.notWorkedTiles).map(t=>t.id)}:{}}function Ht(t){const e=zt.citiesManager.citiesMap.get(t.cityId),i=zt.map.tilesMap.get(t.tileId);return e&&i?(e.workTile(i),W(e)):null}function Jt(t){const e=zt.citiesManager.citiesMap.get(t.cityId),i=zt.map.tilesMap.get(t.tileId);return e&&i?(e.unworkTile(i),W(e)):null}function Kt(t){const e=zt.citiesManager.citiesMap.get(t);return e?(e.optimizeYields(),W(e)):null}function Qt(t){const e=zt.areasManager.areasMap.get(t);return e?Array.from(e.tiles).map(t=>t.id):[]}function Xt(t){const e=t.cityId,i=function(t){const e=pt.get(t);if(!e)throw Error(`DataManager: No entity with id "${t}"`);return e}(t.entityId);if(!i)return[];let s=null;return e&&(s=zt.citiesManager.citiesMap.get(e)),function(t,e,i){return t.weakRequirements.filter(t=>!t.check(e,i)).map(t=>[t.id,t.context])}(i,zt.trackedPlayer,s)}addEventListener("message",({data:t})=>{const e=Yt[t.command];if(!e)return void console.error(`No handler for command "${t.command}".`);const i=e(t.data),s=C.flush();zt.trackedPlayer.updateCitiesWithoutProduction(),zt.trackedPlayer.updateUnitsWithoutOrders();const n=function(){const t=zt.trackedPlayer;return t.citiesWithoutProduction.length?{task:"city",id:t.citiesWithoutProduction[0].id}:t.unitsWithoutOrders.length?{task:"unit",id:t.unitsWithoutOrders[0].id}:null}();postMessage({result:i,changes:s,nextTask:n})})}});